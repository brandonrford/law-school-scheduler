<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Course & GPA Planner with Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container, .schedule-container {
            max-height: 65vh;
            overflow-y: auto;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: 30px repeat(14, 50px); /* 7am to 9pm */
            position: relative;
        }
        .time-label {
            grid-column: 1;
            text-align: right;
            padding-right: 10px;
            font-size: 10px;
            color: #6b7280;
        }
        .day-header {
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .grid-cell {
            border-top: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
        }
        .course-block {
            position: absolute;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            overflow: hidden;
            cursor: pointer;
            z-index: 5;
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .semester-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Law School Course & GPA Planner</h1>
                    <p class="text-gray-600 mt-1">Your comprehensive tool for academic planning.</p>
                </div>
                <div id="auth-status" class="mt-4 md:mt-0 text-right">
                     <p class="text-xs text-gray-500">User ID: <span id="userIdDisplay" class="font-mono">Loading...</span></p>
                     <p class="text-xs text-gray-500">Status: <span id="status" class="font-semibold">Connecting...</span></p>
                </div>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-courses" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">My Courses & GPA</button>
                    <button id="tab-scheduler" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Schedule Planner</button>
                </nav>
            </div>
        </div>

        <!-- Courses View -->
        <div id="view-courses">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 text-center">
                <div class="bg-blue-50 p-4 rounded-lg"><h3 class="text-sm font-semibold text-blue-800 uppercase">Credits Earned</h3><p id="totalCredits" class="text-3xl font-bold text-blue-900">0</p></div>
                <div class="bg-green-50 p-4 rounded-lg"><h3 class="text-sm font-semibold text-green-800 uppercase">Cumulative GPA</h3><p id="cumulativeGpa" class="text-3xl font-bold text-green-900">0.00</p></div>
                <div class="bg-indigo-50 p-4 rounded-lg"><h3 class="text-sm font-semibold text-indigo-800 uppercase">Filtered Semester GPA</h3><p id="semesterGpa" class="text-3xl font-bold text-indigo-900">0.00</p></div>
                <div id="graduationStatusContainer" class="bg-gray-50 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-800 uppercase">Graduation Status</h3><p id="graduationStatus" class="text-3xl font-bold text-gray-900">-</p></div>
            </div>
             <!-- Benchmarks -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Class Rank Benchmarks</h2>
                    <div>
                        <label for="yearSelector" class="mr-2 text-sm font-medium">My Year:</label>
                        <select id="yearSelector" class="rounded-md border-gray-300 shadow-sm">
                            <option value="1L">1L</option>
                            <option value="2L">2L</option>
                            <option value="3L">3L</option>
                        </select>
                    </div>
                </div>
                <div id="benchmarkDisplay" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Benchmark data will be injected here -->
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div class="flex items-center space-x-2"><label for="semesterFilter" class="text-sm font-medium text-gray-700">Filter by Semester:</label><select id="semesterFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="all">All Semesters</option></select></div>
                <button id="addCourseBtn" class="mt-4 md:mt-0 w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Add New Course</button>
            </div>
            <div class="bg-white rounded-xl shadow-lg"><div class="table-container"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr><th scope="col" class="px-6 py-3">Course Code</th><th scope="col" class="px-6 py-3">Course Name</th><th scope="col" class="px-6 py-3 text-center">Credits</th><th scope="col" class="px-6 py-3">Grade</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Semester</th><th scope="col" class="px-6 py-3 text-right">Actions</th></tr></thead><tbody id="course-list"></tbody></table></div><div id="loadingCourses" class="text-center p-8 text-gray-500">Loading courses...</div></div>
        </div>

        <!-- Scheduler View -->
        <div id="view-scheduler" class="hidden">
             <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Semester Plans</h2>
                <div id="semester-tabs-container" class="border-b border-gray-200 mb-4">
                    <nav id="semester-tabs" class="-mb-px flex space-x-6" aria-label="Semesters">
                        <!-- Semester tabs will be injected here -->
                    </nav>
                </div>
                <div id="plan-controls" class="flex flex-col md:flex-row justify-between items-center hidden">
                    <div class="flex items-center space-x-4">
                        <label for="planSelector" class="text-sm font-medium text-gray-700">Current Plan:</label>
                        <select id="planSelector" class="rounded-md border-gray-300 shadow-sm"></select>
                        <button id="addPlanBtn" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">+ New Plan</button>
                        <button id="deletePlanBtn" class="text-red-600 hover:text-red-800 text-sm font-medium hidden">Delete Plan</button>
                    </div>
                    <button id="addCourseToScheduleBtn" class="mt-4 md:mt-0 w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Add Course to Schedule</button>
                </div>
                <div id="no-in-progress-semesters" class="text-center text-gray-500 py-4">Add a course with status "In Progress" to create a schedule plan.</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-2 schedule-container">
                <div id="schedule-grid" class="schedule-grid">
                    <!-- Grid lines and labels will be generated by JS -->
                </div>
                 <div id="loadingScheduler" class="text-center p-8 text-gray-500">Loading schedule...</div>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal-backdrop hidden"><div class="modal-content"><h2 id="modalTitle" class="text-xl font-bold mb-4">Add New Course</h2><form id="courseForm"><input type="hidden" id="courseId"><div class="mb-4"><label for="courseCode" class="block text-sm font-medium text-gray-700">Course Code</label><input type="text" id="courseCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="e.g., LAW 6010"></div><div class="mb-4"><label for="courseName" class="block text-sm font-medium text-gray-700">Course Name</label><input type="text" id="courseName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="e.g., Torts"></div><div class="grid grid-cols-2 gap-4"><div class="mb-4"><label for="credits" class="block text-sm font-medium text-gray-700">Credits</label><input type="number" id="credits" min="0" step="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="e.g., 3"></div><div class="mb-4"><label for="courseStatus" class="block text-sm font-medium text-gray-700">Status</label><select id="courseStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="In Progress">In Progress</option><option value="Complete">Complete</option></select></div></div><div class="mb-4"><label for="grade" class="block text-sm font-medium text-gray-700">Grade</label><input type="text" id="grade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="65-100, S, or U"></div><div class="mb-6"><label for="semester" class="block text-sm font-medium text-gray-700">Semester</label><input type="text" id="semester" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="e.g., Fall 2025"></div><div class="flex justify-end space-x-2"><button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Course</button></div></form></div></div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal-backdrop hidden"><div class="modal-content"><h2 id="scheduleModalTitle" class="text-xl font-bold mb-4">Add Course to Schedule</h2><form id="scheduleForm"><input type="hidden" id="scheduledCourseId"><div class="mb-4"><label for="scheduleCourseSelect" class="block text-sm font-medium text-gray-700">Course</label><select id="scheduleCourseSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Days</label><div class="mt-2 grid grid-cols-3 sm:grid-cols-5 gap-2" id="daysOfWeek"></div></div><div class="grid grid-cols-2 gap-4 mb-6"><div class="mb-4"><label for="startTime" class="block text-sm font-medium text-gray-700">Start Time</label><input type="time" id="startTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div class="mb-4"><label for="endTime" class="block text-sm font-medium text-gray-700">End Time</label><input type="time" id="endTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div></div><p id="formError" class="text-red-500 text-sm mb-4 hidden"></p><div class="flex justify-between items-center"><button type="button" id="deleteScheduledCourseBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 hidden">Delete from Schedule</button><div class="flex justify-end space-x-2"><button type="button" id="cancelScheduleBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save to Schedule</button></div></div></form></div></div>

    <!-- New Plan Modal -->
    <div id="planModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Create New Plan</h2>
            <form id="planForm">
                <div class="mb-4">
                    <label for="planName" class="block text-sm font-medium text-gray-700">Plan Name</label>
                    <input type="text" id="planName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="e.g., Plan A">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelPlanBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Plan</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & CONSTANTS ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'course-planner-default';
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const COLORS = ['bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-teal-500', 'bg-orange-500'];
        const tailwindToHex = {
            'bg-red-500': '#ef4444', 'bg-yellow-500': '#eab308', 'bg-green-500': '#22c55e',
            'bg-blue-500': '#3b82f6', 'bg-purple-500': '#8b5cf6', 'bg-pink-500': '#ec4899',
            'bg-teal-500': '#14b8a6', 'bg-orange-500': '#f97316'
        };
        const benchmarks = {
            "1L": { "Top 10%": 91, "Top 25%": 88, "Top 33%": 87, "Median": 84 },
            "2L": { "Top 10%": 91, "Top 25%": 88, "Top 33%": 87, "Median": 86 },
            "3L": { "Top 10%": 92, "Top 25%": 90, "Top 33%": 89, "Median": 87 }
        };

        // --- DOM ELEMENTS ---
        const courseListEl = document.getElementById('course-list');
        const courseModal = document.getElementById('courseModal');
        const scheduleModal = document.getElementById('scheduleModal');
        const planModal = document.getElementById('planModal');
        const planSelector = document.getElementById('planSelector');
        const scheduleGrid = document.getElementById('schedule-grid');
        const loadingCoursesDiv = document.getElementById('loadingCourses');
        const loadingSchedulerDiv = document.getElementById('loadingScheduler');
        const formError = document.getElementById('formError');
        const yearSelector = document.getElementById('yearSelector');
        const benchmarkDisplay = document.getElementById('benchmarkDisplay');
        const semesterTabsContainer = document.getElementById('semester-tabs');
        const planControls = document.getElementById('plan-controls');
        const noInProgressSemestersMsg = document.getElementById('no-in-progress-semesters');

        // --- FIREBASE & STATE ---
        let app, auth, db, userId;
        let coursesCollectionRef, plansCollectionRef;
        let unsubscribeCourses, unsubscribePlans, unsubscribeScheduledCourses;
        
        let allCourses = [];
        let allPlans = [];
        let scheduledCourses = [];
        let courseColorMap = {};
        let activeSemester = null;
        let currentPlanId = null;

        // --- INITIALIZATION ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('status').textContent = 'Connected';
                        document.getElementById('status').classList.add('text-green-600');
                        document.getElementById('userIdDisplay').textContent = userId;
                        
                        coursesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/courses`);
                        plansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans`);
                        
                        listenForCourseUpdates();
                        listenForPlanUpdates();
                    } else {
                        // Handle sign-out
                        userId = null;
                        document.getElementById('status').textContent = 'Disconnected';
                        document.getElementById('status').classList.remove('text-green-600');
                        document.getElementById('userIdDisplay').textContent = 'N/A';
                        if (unsubscribeCourses) unsubscribeCourses();
                        if (unsubscribePlans) unsubscribePlans();
                        if (unsubscribeScheduledCourses) unsubscribeScheduledCourses();
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('status').textContent = 'Error';
            }
        }

        // --- DATA LISTENERS ---
        function listenForCourseUpdates() {
            if (!coursesCollectionRef) return;
            loadingCoursesDiv.style.display = 'block';
            unsubscribeCourses = onSnapshot(coursesCollectionRef, (snapshot) => {
                allCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCourses();
                updateCalculations();
                updateSemesterFilter();
                updateCourseColorMap();
                renderSemesterTabs();
                loadingCoursesDiv.style.display = 'none';
            });
        }

        function listenForPlanUpdates() {
            if (!plansCollectionRef) return;
            unsubscribePlans = onSnapshot(plansCollectionRef, (snapshot) => {
                allPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPlanSelector();
            });
        }

        function listenForScheduledCourseUpdates() {
            if (unsubscribeScheduledCourses) unsubscribeScheduledCourses();
            if (!currentPlanId) {
                scheduledCourses = [];
                renderSchedule();
                loadingSchedulerDiv.style.display = 'none';
                return;
            }
            loadingSchedulerDiv.style.display = 'block';
            const scheduledCoursesRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`);
            unsubscribeScheduledCourses = onSnapshot(scheduledCoursesRef, (snapshot) => {
                scheduledCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule();
                loadingSchedulerDiv.style.display = 'none';
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function renderCourses() {
            const selectedSemester = document.getElementById('semesterFilter').value;
            const coursesToRender = selectedSemester === 'all' ? allCourses : allCourses.filter(c => c.semester === selectedSemester);
            courseListEl.innerHTML = '';
            if (coursesToRender.length === 0) {
                 courseListEl.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">No courses found.</td></tr>`;
                 return;
            }
            coursesToRender.sort((a,b) => (a.semester||'').localeCompare(b.semester||'') || (a.courseCode||'').localeCompare(b.courseCode||''));
            coursesToRender.forEach(c => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${c.courseCode||''}</td><td class="px-6 py-4">${c.courseName||''}</td><td class="px-6 py-4 text-center">${c.credits||0}</td><td class="px-6 py-4"><span class="font-semibold ${c.grade ? 'text-gray-800' : 'text-yellow-600'}">${c.grade||'-'}</span></td><td class="px-6 py-4">${c.status||'In Progress'}</td><td class="px-6 py-4">${c.semester||''}</td><td class="px-6 py-4 text-right"><button data-id="${c.id}" class="edit-btn font-medium text-indigo-600 hover:underline mr-3">Edit</button><button data-id="${c.id}" class="delete-btn font-medium text-red-600 hover:underline">Delete</button></td>`;
                courseListEl.appendChild(row);
            });
        }

        function renderSemesterTabs() {
            const inProgressSemesters = [...new Set(allCourses.filter(c => c.status === 'In Progress').map(c => c.semester))].sort();
            semesterTabsContainer.innerHTML = '';

            if (inProgressSemesters.length === 0) {
                planControls.classList.add('hidden');
                noInProgressSemestersMsg.classList.remove('hidden');
                activeSemester = null;
                currentPlanId = null;
                renderSchedule();
                return;
            }
            
            planControls.classList.remove('hidden');
            noInProgressSemestersMsg.classList.add('hidden');

            if (!activeSemester || !inProgressSemesters.includes(activeSemester)) {
                activeSemester = inProgressSemesters[0];
            }

            inProgressSemesters.forEach(semester => {
                const tab = document.createElement('button');
                tab.className = 'semester-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                tab.textContent = semester;
                tab.dataset.semester = semester;
                if (semester === activeSemester) {
                    tab.classList.add('active');
                }
                tab.addEventListener('click', () => {
                    activeSemester = semester;
                    renderSemesterTabs();
                });
                semesterTabsContainer.appendChild(tab);
            });
            renderPlanSelector();
        }

        function renderPlanSelector() {
            if (!activeSemester) {
                planSelector.innerHTML = '<option>No semester selected</option>';
                currentPlanId = null;
                listenForScheduledCourseUpdates();
                return;
            }

            const plansForSemester = allPlans.filter(p => p.semester === activeSemester);
            planSelector.innerHTML = '';

            if (plansForSemester.length === 0) {
                planSelector.innerHTML = '<option>No plans for this semester</option>';
                currentPlanId = null;
            } else {
                plansForSemester.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = plan.name;
                    planSelector.appendChild(option);
                });
                currentPlanId = planSelector.value;
            }
            document.getElementById('deletePlanBtn').classList.toggle('hidden', plansForSemester.length === 0);
            listenForScheduledCourseUpdates();
        }
        
        function generateScheduleGrid() {
            scheduleGrid.innerHTML = '';
            scheduleGrid.innerHTML += `<div class="day-header"></div>` + DAYS.map(day => `<div class="day-header">${day}</div>`).join('');
            for (let hour = 7; hour < 21; hour++) {
                const timeLabelDiv = document.createElement('div');
                timeLabelDiv.className = 'time-label';
                timeLabelDiv.textContent = formatTimeAMPM(`${hour}:00`);
                timeLabelDiv.style.gridRow = hour - 7 + 2;
                scheduleGrid.appendChild(timeLabelDiv);
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.gridColumn = dayIndex + 2;
                    cell.style.gridRow = hour - 7 + 2;
                    scheduleGrid.appendChild(cell);
                }
            }
        }

        function renderSchedule() {
            scheduleGrid.querySelectorAll('.course-block').forEach(el => el.remove());
            if (!currentPlanId) return;
            scheduledCourses.forEach(course => {
                const start = timeToMinutes(course.startTime);
                const end = timeToMinutes(course.endTime);
                if (!course.startTime || !course.endTime || end <= start) return;
                const duration = end - start;
                const top = ((start - (7 * 60)) / 60) * 50 + 30;
                const height = (duration / 60) * 50;
                course.days.forEach(day => {
                    const dayIndex = DAYS.indexOf(day);
                    if (dayIndex === -1) return;
                    const bgColorClass = courseColorMap[course.courseId] || 'bg-gray-500';
                    const hexColor = tailwindToHex[bgColorClass] || '#6b7280';
                    const textColorClass = getTextColorForBg(hexColor);
                    const block = document.createElement('div');
                    block.className = `course-block ${bgColorClass} ${textColorClass}`;
                    block.style.top = `${top}px`;
                    block.style.height = `${height}px`;
                    block.style.left = `calc(60px + ${dayIndex} * (100% - 60px) / 5)`;
                    block.style.width = `calc(((100% - 60px) / 5) - 4px)`;
                    block.innerHTML = `<strong>${course.courseCode}</strong><p>${formatTimeAMPM(course.startTime)} - ${formatTimeAMPM(course.endTime)}</p>`;
                    block.dataset.id = course.id;
                    block.addEventListener('click', () => showScheduleModal(course));
                    scheduleGrid.appendChild(block);
                });
            });
        }

        // --- CALCULATIONS & HELPERS ---
        function getTextColorForBg(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? 'text-gray-900' : 'text-white';
        }

        function formatTimeAMPM(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minutes} ${ampm}`;
        }

        function calculateLawSchoolGpa(courses) {
            let totalPoints = 0;
            let creditsForGpa = 0;
            let creditsEarned = 0;

            courses.forEach(course => {
                const credits = parseFloat(course.credits) || 0;
                const grade = course.grade;
                const numericGrade = parseFloat(grade);

                if (!isNaN(numericGrade) && numericGrade >= 65) {
                    totalPoints += numericGrade * credits;
                    creditsForGpa += credits;
                }
                
                if ((!isNaN(numericGrade) && numericGrade >= 70) || grade === 'S') {
                    creditsEarned += credits;
                }
            });

            const gpa = creditsForGpa > 0 ? totalPoints / creditsForGpa : 0;
            return { gpa, creditsEarned, creditsForGpa };
        }

        function updateCalculations() {
            const selectedSemester = document.getElementById('semesterFilter').value;
            
            const { gpa: cumulativeGpa, creditsEarned, creditsForGpa } = calculateLawSchoolGpa(allCourses);
            document.getElementById('cumulativeGpa').textContent = cumulativeGpa.toFixed(3);
            document.getElementById('totalCredits').textContent = creditsEarned;

            const semesterCourses = selectedSemester === 'all' ? allCourses : allCourses.filter(course => course.semester === selectedSemester);
            const { gpa: semesterGpa } = calculateLawSchoolGpa(semesterCourses);
            document.getElementById('semesterGpa').textContent = semesterGpa.toFixed(3);

            const gradStatusEl = document.getElementById('graduationStatus');
            if (cumulativeGpa > 76.999) {
                gradStatusEl.textContent = 'On Track';
                gradStatusEl.className = 'text-3xl font-bold text-green-600';
            } else if (creditsForGpa > 0) {
                gradStatusEl.textContent = 'At Risk';
                gradStatusEl.className = 'text-3xl font-bold text-red-600';
            } else {
                gradStatusEl.textContent = '-';
                gradStatusEl.className = 'text-3xl font-bold text-gray-900';
            }
            
            updateBenchmarkDisplay(cumulativeGpa);
        }
        
        function updateBenchmarkDisplay(gpa) {
            const year = yearSelector.value;
            const yearBenchmarks = benchmarks[year];
            benchmarkDisplay.innerHTML = '';

            for (const [rank, value] of Object.entries(yearBenchmarks)) {
                const isAchieved = gpa >= value;
                const color = isAchieved ? 'text-green-600' : 'text-red-500';
                const icon = isAchieved ? '✓' : '✗';
                
                const div = document.createElement('div');
                div.className = `p-2 rounded-lg ${isAchieved ? 'bg-green-50' : 'bg-red-50'}`;
                div.innerHTML = `
                    <h4 class="text-sm font-semibold text-gray-700">${rank}</h4>
                    <p class="text-xl font-bold ${color}">${value}</p>
                    <p class="text-xs ${color}">${icon} ${isAchieved ? 'Achieved' : 'Not Met'}</p>
                `;
                benchmarkDisplay.appendChild(div);
            }
        }

        function updateSemesterFilter() {
            const semesterFilter = document.getElementById('semesterFilter');
            const semesters = [...new Set(allCourses.map(c => c.semester).filter(Boolean))].sort().reverse();
            const currentVal = semesterFilter.value;
            while (semesterFilter.options.length > 1) { semesterFilter.remove(1); }
            semesters.forEach(semester => {
                const option = document.createElement('option');
                option.value = semester;
                option.textContent = semester;
                semesterFilter.appendChild(option);
            });
            if (semesters.includes(currentVal)) { semesterFilter.value = currentVal; }
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function updateCourseColorMap() {
            allCourses.forEach((course, index) => {
                if (!courseColorMap[course.id]) {
                    courseColorMap[course.id] = COLORS[index % COLORS.length];
                }
            });
        }

        function checkConflict(newCourse) {
            for (const existingCourse of scheduledCourses) {
                if (newCourse.id && newCourse.id === existingCourse.id) continue;
                const hasCommonDay = newCourse.days.some(day => existingCourse.days.includes(day));
                if (!hasCommonDay) continue;
                const newStart = timeToMinutes(newCourse.startTime);
                const newEnd = timeToMinutes(newCourse.endTime);
                const existingStart = timeToMinutes(existingCourse.startTime);
                const existingEnd = timeToMinutes(existingCourse.endTime);
                if (newStart < existingEnd && newEnd > existingStart) return true;
            }
            return false;
        }

        // --- MODALS & FORMS ---
        function showCourseModal(course = null) {
            const form = document.getElementById('courseForm');
            form.reset();
            const gradeInput = document.getElementById('grade');

            if (course) {
                document.getElementById('modalTitle').textContent = 'Edit Course';
                document.getElementById('courseId').value = course.id;
                document.getElementById('courseCode').value = course.courseCode;
                document.getElementById('courseName').value = course.courseName;
                document.getElementById('credits').value = course.credits;
                document.getElementById('courseStatus').value = course.status || 'In Progress';
                document.getElementById('grade').value = course.grade || '';
                document.getElementById('semester').value = course.semester;
            } else {
                document.getElementById('modalTitle').textContent = 'Add New Course';
                document.getElementById('courseId').value = '';
                document.getElementById('courseStatus').value = 'In Progress';
            }

            const status = document.getElementById('courseStatus').value;
            gradeInput.disabled = status === 'In Progress';
            gradeInput.classList.toggle('bg-gray-100', gradeInput.disabled);

            courseModal.classList.remove('hidden');
        }
        function hideCourseModal() { courseModal.classList.add('hidden'); }
        
        function showScheduleModal(course = null) {
            document.getElementById('scheduleForm').reset();
            formError.classList.add('hidden');
            const select = document.getElementById('scheduleCourseSelect');
            select.innerHTML = '<option value="">Select a course...</option>';
            
            const availableCourses = allCourses.filter(c => c.status === 'In Progress' && c.semester === activeSemester);
            availableCourses.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.courseCode} - ${c.courseName}</option>`; });

            const daysContainer = document.getElementById('daysOfWeek');
            daysContainer.innerHTML = '';
            DAYS.forEach(day => { daysContainer.innerHTML += `<label class="flex items-center space-x-2"><input type="checkbox" name="days" value="${day}" class="rounded"><span>${day.substring(0,3)}</span></label>`; });
            if (course) {
                document.getElementById('scheduleModalTitle').textContent = 'Edit Scheduled Course';
                document.getElementById('scheduledCourseId').value = course.id;
                select.value = course.courseId;
                document.getElementById('startTime').value = course.startTime;
                document.getElementById('endTime').value = course.endTime;
                course.days.forEach(day => {
                    const checkbox = daysContainer.querySelector(`input[value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                document.getElementById('deleteScheduledCourseBtn').classList.remove('hidden');
            } else {
                document.getElementById('scheduleModalTitle').textContent = 'Add Course to Schedule';
                document.getElementById('scheduledCourseId').value = '';
                document.getElementById('deleteScheduledCourseBtn').classList.add('hidden');
            }
            scheduleModal.classList.remove('hidden');
        }
        function hideScheduleModal() { scheduleModal.classList.add('hidden'); }

        function showPlanModal() {
            document.getElementById('planForm').reset();
            planModal.classList.remove('hidden');
        }
        function hidePlanModal() {
            planModal.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        yearSelector.addEventListener('change', () => updateCalculations());

        document.getElementById('tab-courses').addEventListener('click', () => {
            document.getElementById('view-courses').classList.remove('hidden');
            document.getElementById('view-scheduler').classList.add('hidden');
            document.getElementById('tab-courses').classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById('tab-scheduler').classList.remove('border-indigo-500', 'text-indigo-600');
        });
        document.getElementById('tab-scheduler').addEventListener('click', () => {
            document.getElementById('view-courses').classList.add('hidden');
            document.getElementById('view-scheduler').classList.remove('hidden');
            document.getElementById('tab-scheduler').classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById('tab-courses').classList.remove('border-indigo-500', 'text-indigo-600');
        });

        document.getElementById('courseStatus').addEventListener('change', (e) => {
            const gradeInput = document.getElementById('grade');
            const isDisabled = e.target.value === 'In Progress';
            gradeInput.disabled = isDisabled;
            gradeInput.classList.toggle('bg-gray-100', isDisabled);
            if (isDisabled) {
                gradeInput.value = '';
            }
        });

        document.getElementById('addCourseBtn').addEventListener('click', () => showCourseModal());
        document.getElementById('cancelBtn').addEventListener('click', hideCourseModal);
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            const status = document.getElementById('courseStatus').value;
            const gradeInput = document.getElementById('grade').value.trim().toUpperCase();
            
            if (status === 'Complete') {
                const numericGrade = parseFloat(gradeInput);
                let isValid = false;
                if (gradeInput === 'S' || gradeInput === 'U' || (!isNaN(numericGrade) && numericGrade >= 65 && numericGrade <= 100)) {
                    isValid = true;
                }
                if (!isValid) {
                    alert('For a complete course, please enter a valid grade (65-100, S, or U).');
                    return;
                }
            }

            const courseData = { 
                courseCode: document.getElementById('courseCode').value, 
                courseName: document.getElementById('courseName').value, 
                credits: parseFloat(document.getElementById('credits').value) || 0, 
                status: status,
                grade: status === 'Complete' ? gradeInput : '', 
                semester: document.getElementById('semester').value, 
            };
            const courseId = document.getElementById('courseId').value;
            try {
                if (courseId) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/courses`, courseId), courseData);
                } else {
                    await addDoc(coursesCollectionRef, courseData);
                }
                hideCourseModal();
            } catch (error) { console.error("Error saving course: ", error); }
        });
        courseListEl.addEventListener('click', async (e) => {
            if (!userId) return;
            const target = e.target;
            const id = target.dataset.id;
            if (target.classList.contains('edit-btn')) {
                const course = allCourses.find(c => c.id === id);
                if (course) showCourseModal(course);
            }
            if (target.classList.contains('delete-btn')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/courses`, id));
                } catch (error) { console.error("Error deleting course: ", error); }
            }
        });
        document.getElementById('semesterFilter').addEventListener('change', updateCalculations);

        document.getElementById('addCourseToScheduleBtn').addEventListener('click', () => showScheduleModal());
        document.getElementById('cancelScheduleBtn').addEventListener('click', hideScheduleModal);
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('hidden');
            if (!currentPlanId) {
                formError.textContent = 'Please create or select a plan first.';
                formError.classList.remove('hidden');
                return;
            };

            const courseId = document.getElementById('scheduleCourseSelect').value;
            const selectedCourse = allCourses.find(c => c.id === courseId);
            if (!selectedCourse) {
                formError.textContent = 'Please select a course from the dropdown.';
                formError.classList.remove('hidden');
                return;
            }

            const selectedDays = Array.from(document.querySelectorAll('#daysOfWeek input:checked')).map(cb => cb.value);
            if (selectedDays.length === 0) {
                formError.textContent = 'Please select at least one day of the week.';
                formError.classList.remove('hidden');
                return;
            }
            
            const scheduledCourseData = { 
                id: document.getElementById('scheduledCourseId').value, 
                courseId: courseId, 
                courseCode: selectedCourse.courseCode, 
                days: selectedDays, 
                startTime: document.getElementById('startTime').value, 
                endTime: document.getElementById('endTime').value, 
            };

            if (checkConflict(scheduledCourseData)) {
                formError.textContent = 'Warning: This time conflicts with another course in this plan.';
                formError.classList.remove('hidden');
                return;
            }

            const scheduleDocRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`);
            try {
                if (scheduledCourseData.id) {
                    const docRef = doc(scheduleDocRef, scheduledCourseData.id);
                    const { id, ...dataToUpdate } = scheduledCourseData;
                    await updateDoc(docRef, dataToUpdate);
                } else {
                    const { id, ...dataToAdd } = scheduledCourseData;
                    await addDoc(scheduleDocRef, dataToAdd);
                }
                hideScheduleModal();
            } catch (error) { 
                console.error("Error saving scheduled course: ", error); 
                formError.textContent = 'Error saving to database. See console for details.';
                formError.classList.remove('hidden');
            }
        });
        document.getElementById('deleteScheduledCourseBtn').addEventListener('click', async () => {
            const id = document.getElementById('scheduledCourseId').value;
            if (!id || !currentPlanId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`, id));
                hideScheduleModal();
            } catch (error) { console.error("Error deleting scheduled course:", error); }
        });

        // Plan Modal Listeners
        document.getElementById('addPlanBtn').addEventListener('click', showPlanModal);
        document.getElementById('cancelPlanBtn').addEventListener('click', hidePlanModal);
        document.getElementById('planForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activeSemester) {
                alert("Please select a semester tab first.");
                return;
            }
            const planNameInput = document.getElementById('planName');
            const planName = planNameInput.value.trim();
            if (planName && plansCollectionRef) {
                try {
                    const newPlan = await addDoc(plansCollectionRef, { name: planName, semester: activeSemester });
                    currentPlanId = newPlan.id;
                    hidePlanModal();
                } catch (error) {
                    console.error("Error creating new plan:", error);
                }
            }
        });

        document.getElementById('deletePlanBtn').addEventListener('click', async () => {
            if (!currentPlanId) return;
            if (confirm("Are you sure you want to delete this plan? This cannot be undone.")) {
                 try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedulePlans`, currentPlanId));
                    currentPlanId = null; 
                } catch (error) { console.error("Error deleting plan:", error); }
            }
        });
        planSelector.addEventListener('change', () => {
            currentPlanId = planSelector.value;
            listenForScheduledCourseUpdates();
        });

        // --- INITIAL LOAD ---
        initializeFirebase();
        generateScheduleGrid();
    </script>
</body>
</html>
