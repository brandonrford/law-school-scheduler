<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mizzou Law School Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
        }
        #bg-wrap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            z-index: -1;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            background: #FDB719;
            filter: blur(100px);
            opacity: 0.15;
        }
        .orb1 { width: 400px; height: 400px; animation: move1 25s infinite alternate; }
        .orb2 { width: 300px; height: 300px; animation: move2 20s infinite alternate; }
        @keyframes move1 {
            0% { transform: translate(10vw, -10vh); }
            100% { transform: translate(70vw, 50vh); }
        }
        @keyframes move2 {
            0% { transform: translate(80vw, 70vh); }
            100% { transform: translate(20vw, 10vh); }
        }

        .table-container, .schedule-container {
            max-height: 65vh;
            overflow-y: auto;
        }
        .glass-panel {
            background: rgba(30, 30, 30, 0.4); /* Darker, less opaque */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .modal-backdrop:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: rgba(30, 30, 30, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
            padding: 2.5rem; /* Increased padding */
            transform: translateY(10px) scale(0.98);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: 30px repeat(28, 25px); /* 30 min slots from 7am to 9pm */
            position: relative;
        }
        .time-label {
            grid-column: 1;
            text-align: right;
            padding-right: 10px;
            font-size: 10px;
            color: #989898; /* Black Tint 2 */
        }
        .day-header {
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 10;
        }
        .grid-cell {
            border-top: 1px solid rgba(152, 152, 152, 0.2);
            border-left: 1px solid rgba(152, 152, 152, 0.2);
        }
        .grid-cell:nth-of-type(2n) {
            border-top-style: dashed;
        }
        .course-block {
            position: absolute;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            overflow: hidden;
            z-index: 5;
            box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        .semester-tab.active {
            border-color: #FDB719; /* Mizzou Gold */
            color: #FDB719;
            background-color: rgba(253, 183, 25, 0.1);
        }
        input[type="time"] {
            color-scheme: dark;
        }
    </style>
</head>
<body class="bg-[#0a0a0a] text-[#D4D4D4]">
    <div id="bg-wrap">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 relative z-10">
        <!-- Header -->
        <div class="glass-panel p-6 md:p-8 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-white">Law School Course & GPA Planner</h1>
                    <p class="text-[#989898] mt-1">Your comprehensive tool for academic planning.</p>
                </div>
                <div id="auth-status" class="mt-4 md:mt-0 text-right">
                     <p class="text-xs text-[#989898]">User ID: <span id="userIdDisplay" class="font-mono">Loading...</span></p>
                     <p class="text-xs text-[#989898]">Status: <span id="status" class="font-semibold">Connecting...</span></p>
                </div>
            </div>
            <!-- Tabs -->
            <div class="border-b border-[#555555]">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-courses" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-[#FDB719] text-[#FDB719]">My Courses & GPA</button>
                    <button id="tab-scheduler" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-[#989898] hover:text-[#D4D4D4] hover:border-gray-500">Schedule Planner</button>
                </nav>
            </div>
        </div>

        <!-- Courses View -->
        <div id="view-courses">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 text-center">
                <div class="glass-panel p-4"><h3 class="text-sm font-semibold text-[#989898] uppercase">Credits Earned</h3><p id="totalCredits" class="text-3xl font-bold text-white">0</p></div>
                <div class="glass-panel p-4"><h3 class="text-sm font-semibold text-[#989898] uppercase">Cumulative GPA</h3><p id="cumulativeGpa" class="text-3xl font-bold text-[#FDB719]">0.00</p></div>
                <div class="glass-panel p-4"><h3 class="text-sm font-semibold text-[#989898] uppercase">Filtered Semester GPA</h3><p id="semesterGpa" class="text-3xl font-bold text-[#FDB719]">0.00</p></div>
                <div id="graduationStatusContainer" class="glass-panel p-4"><h3 class="text-sm font-semibold text-[#989898] uppercase">Graduation Status</h3><p id="graduationStatus" class="text-3xl font-bold text-white">-</p></div>
            </div>
             <!-- Benchmarks -->
            <div class="glass-panel p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">Class Rank Benchmarks</h2>
                    <div>
                        <label for="yearSelector" class="mr-2 text-sm font-medium text-[#D4D4D4]">My Year:</label>
                        <select id="yearSelector" class="rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:ring-[#FDB719] focus:border-[#FDB719] px-3 py-2">
                            <option value="1L">1L</option>
                            <option value="2L">2L</option>
                            <option value="3L">3L</option>
                        </select>
                    </div>
                </div>
                <div id="benchmarkDisplay" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Benchmark data will be injected here -->
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div class="flex items-center space-x-2"><label for="semesterFilter" class="text-sm font-medium text-[#D4D4D4]">Filter by Semester:</label><select id="semesterFilter" class="rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:ring-[#FDB719] focus:border-[#FDB719] px-3 py-2"><option value="all">All Semesters</option></select></div>
                <button id="addCourseBtn" class="mt-4 md:mt-0 w-full md:w-auto bg-[#FDB719] text-[#000000] font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-[#FFD17D] transition">Add New Course</button>
            </div>
            <div class="glass-panel"><div class="table-container"><table class="w-full text-sm text-left text-[#D4D4D4]"><thead class="text-xs text-[#989898] uppercase bg-[#333333]/70 sticky top-0"><tr><th scope="col" class="px-6 py-3">Course Code</th><th scope="col" class="px-6 py-3">Course Name</th><th scope="col" class="px-6 py-3 text-center">Credits</th><th scope="col" class="px-6 py-3">Grade</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Semester</th><th scope="col" class="px-6 py-3 text-right">Actions</th></tr></thead><tbody id="course-list" class="divide-y divide-[#555555]"></tbody></table></div><div id="loadingCourses" class="text-center p-8 text-[#989898]">Loading courses...</div></div>
        </div>

        <!-- Scheduler View -->
        <div id="view-scheduler" class="hidden">
             <div class="glass-panel p-6 mb-6">
                <h2 class="text-xl font-bold text-white mb-4">Semester Plans</h2>
                <div id="semester-tabs-container" class="border-b border-[#555555] mb-4">
                    <nav id="semester-tabs" class="-mb-px flex space-x-6" aria-label="Semesters">
                        <!-- Semester tabs will be injected here -->
                    </nav>
                </div>
                <div id="plan-controls" class="flex flex-col md:flex-row justify-between items-center hidden">
                    <div class="flex items-center space-x-4">
                        <label for="planSelector" class="text-sm font-medium text-[#D4D4D4]">Current Plan:</label>
                        <select id="planSelector" class="rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:ring-[#FDB719] focus:border-[#FDB719] px-3 py-2"></select>
                        <button id="addPlanBtn" class="text-[#FDB719] hover:text-[#FFD17D] text-sm font-medium">+ New Plan</button>
                        <button id="deletePlanBtn" class="text-red-500 hover:text-red-400 text-sm font-medium hidden">Delete Plan</button>
                    </div>
                    <div class="flex items-center space-x-6 mt-4 md:mt-0">
                        <div class="text-center">
                            <h3 class="text-sm font-semibold text-[#989898] uppercase tracking-wider">Plan Credits</h3>
                            <p id="planCredits" class="text-2xl font-bold text-[#FDB719]">0</p>
                        </div>
                        <button id="manageScheduleBtn" class="w-full md:w-auto bg-[#FDB719] text-[#000000] font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-[#FFD17D]">Manage Schedule</button>
                    </div>
                </div>
                <div id="no-in-progress-semesters" class="text-center text-[#989898] py-4">Add a course with status "In Progress" to create a schedule plan.</div>
            </div>
            <div class="glass-panel p-2 schedule-container">
                <div id="schedule-grid" class="schedule-grid">
                    <!-- Grid lines and labels will be generated by JS -->
                </div>
                 <div id="loadingScheduler" class="text-center p-8 text-[#989898]">Loading schedule...</div>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal-backdrop hidden"><div class="modal-content"><h2 id="modalTitle" class="text-xl font-bold text-white mb-4">Add New Course</h2><form id="courseForm"><input type="hidden" id="courseId"><div class="mb-4"><label for="courseCode" class="block text-sm font-medium text-[#D4D4D4]">Course Code</label><input type="text" id="courseCode" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" required placeholder="e.g., LAW 6010"></div><div class="mb-4"><label for="courseName" class="block text-sm font-medium text-[#D4D4D4]">Course Name</label><input type="text" id="courseName" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" required placeholder="e.g., Torts"></div><div class="mb-4"><label for="credits" class="block text-sm font-medium text-[#D4D4D4]">Credits</label><input type="number" id="credits" min="0" step="0.5" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" required placeholder="e.g., 3"></div><div class="mb-4"><label for="semester" class="block text-sm font-medium text-[#D4D4D4]">Semester</label><input type="text" id="semester" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" required placeholder="e.g., Fall 2025"></div><div class="mb-4"><label for="courseStatus" class="block text-sm font-medium text-[#D4D4D4]">Status</label><select id="courseStatus" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2"><option value="In Progress">In Progress</option><option value="Complete">Complete</option></select></div><div id="inProgressFields"><div class="mb-4"><label class="block text-sm font-medium text-[#D4D4D4]">Days</label><div id="courseDays" class="mt-2 grid grid-cols-3 sm:grid-cols-5 gap-2"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div class="mb-4"><label for="startTime" class="block text-sm font-medium text-[#D4D4D4]">Start Time</label><input type="time" id="startTime" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2"></div><div class="mb-4"><label for="endTime" class="block text-sm font-medium text-[#D4D4D4]">End Time</label><input type="time" id="endTime" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2"></div></div></div><div class="mb-6"><label for="grade" class="block text-sm font-medium text-[#D4D4D4]">Grade</label><input type="text" id="grade" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" placeholder="65-100, S, or U"></div><div class="flex justify-end space-x-2"><button type="button" id="cancelBtn" class="bg-[#989898] text-[#000000] font-semibold py-2 px-4 rounded-lg hover:bg-[#D4D4D4]">Cancel</button><button type="submit" class="bg-[#FDB719] text-[#000000] font-semibold py-2 px-4 rounded-lg hover:bg-[#FFD17D]">Save Course</button></div></form></div></div>
    
    <!-- Checklist Modal -->
    <div id="checklistModal" class="modal-backdrop hidden"><div class="modal-content p-8"><h2 class="text-xl font-bold text-white mb-4">Add Courses to Plan</h2><div id="checklist-container" class="space-y-3 max-h-96 overflow-y-auto"></div><div class="flex justify-end mt-6"><button type="button" id="closeChecklistBtn" class="bg-[#FDB719] text-[#000000] font-semibold py-2 px-4 rounded-lg hover:bg-[#FFD17D]">Done</button></div></div></div>

    <!-- New Plan Modal -->
    <div id="planModal" class="modal-backdrop hidden">
        <div class="modal-content p-8">
            <h2 class="text-xl font-bold text-white mb-4">Create New Plan</h2>
            <form id="planForm">
                <div class="mb-4">
                    <label for="planName" class="block text-sm font-medium text-[#D4D4D4]">Plan Name</label>
                    <input type="text" id="planName" class="mt-1 block w-full rounded-md border-[#555555] bg-[#333333] text-white shadow-sm focus:border-[#FDB719] focus:ring-[#FDB719] px-3 py-2" required placeholder="e.g., Plan A">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelPlanBtn" class="bg-[#989898] text-[#000000] font-semibold py-2 px-4 rounded-lg hover:bg-[#D4D4D4]">Cancel</button>
                    <button type="submit" class="bg-[#FDB719] text-[#000000] font-semibold py-2 px-4 rounded-lg hover:bg-[#FFD17D]">Save Plan</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & CONSTANTS ---
        const firebaseConfig = {
            apiKey: "AIzaSyAl5j28ERUYog1FgVcTqs2SEWMG-rt8fI4",
            authDomain: "law-school-scheduler.firebaseapp.com",
            projectId: "law-school-scheduler",
            storageBucket: "law-school-scheduler.firebasestorage.app",
            messagingSenderId: "292569639844",
            appId: "1:292569639844:web:162d8b1dd0e943140caf31"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'course-planner-default';
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const COLORS = ['bg-[#FDB719]', 'bg-[#FFD17D]', 'bg-[#989898]', 'bg-[#FFDFA5]', 'bg-[#D4D4D4]', 'bg-[#FFEDCF]'];
        const tailwindToHex = {
            'bg-[#FDB719]': '#FDB719', 'bg-[#FFD17D]': '#FFD17D', 'bg-[#989898]': '#989898',
            'bg-[#FFDFA5]': '#FFDFA5', 'bg-[#D4D4D4]': '#D4D4D4', 'bg-[#FFEDCF]': '#FFEDCF'
        };
        const benchmarks = {
            "1L": { "Top 10%": 91, "Top 25%": 88, "Top 33%": 87, "Median": 84 },
            "2L": { "Top 10%": 91, "Top 25%": 88, "Top 33%": 87, "Median": 86 },
            "3L": { "Top 10%": 92, "Top 25%": 90, "Top 33%": 89, "Median": 87 }
        };

        // --- DOM ELEMENTS ---
        const courseListEl = document.getElementById('course-list');
        const courseModal = document.getElementById('courseModal');
        const planModal = document.getElementById('planModal');
        const checklistModal = document.getElementById('checklistModal');
        const planSelector = document.getElementById('planSelector');
        const scheduleGrid = document.getElementById('schedule-grid');
        const loadingCoursesDiv = document.getElementById('loadingCourses');
        const loadingSchedulerDiv = document.getElementById('loadingScheduler');
        const yearSelector = document.getElementById('yearSelector');
        const benchmarkDisplay = document.getElementById('benchmarkDisplay');
        const semesterTabsContainer = document.getElementById('semester-tabs');
        const planControls = document.getElementById('plan-controls');
        const noInProgressSemestersMsg = document.getElementById('no-in-progress-semesters');
        const semesterFilter = document.getElementById('semesterFilter');
        const planCreditsEl = document.getElementById('planCredits');
        const checklistContainer = document.getElementById('checklist-container');
        const tabCourses = document.getElementById('tab-courses');
        const tabScheduler = document.getElementById('tab-scheduler');

        // --- FIREBASE & STATE ---
        let app, auth, db, userId;
        let coursesCollectionRef, plansCollectionRef;
        let unsubscribeCourses, unsubscribePlans, unsubscribeScheduledCourses;
        
        let allCourses = [];
        let allPlans = [];
        let scheduledCourses = [];
        let courseColorMap = {};
        let activeSemester = null;
        let currentPlanId = null;

        // --- INITIALIZATION ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('off');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('status').textContent = 'Connected';
                        document.getElementById('status').classList.add('text-green-400');
                        document.getElementById('userIdDisplay').textContent = userId;
                        
                        coursesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/courses`);
                        plansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans`);
                        
                        listenForCourseUpdates();
                        listenForPlanUpdates();
                    } else {
                        // Handle sign-out
                        userId = null;
                        document.getElementById('status').textContent = 'Disconnected';
                        document.getElementById('status').classList.remove('text-green-400');
                        document.getElementById('userIdDisplay').textContent = 'N/A';
                        if (unsubscribeCourses) unsubscribeCourses();
                        if (unsubscribePlans) unsubscribePlans();
                        if (unsubscribeScheduledCourses) unsubscribeScheduledCourses();
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('status').textContent = 'Error';
            }
        }

        // --- DATA LISTENERS ---
        function listenForCourseUpdates() {
            if (!coursesCollectionRef) return;
            loadingCoursesDiv.style.display = 'block';
            unsubscribeCourses = onSnapshot(coursesCollectionRef, (snapshot) => {
                allCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCourses();
                updateCalculations();
                updateSemesterFilter();
                updateCourseColorMap();
                renderSemesterTabs();
                loadingCoursesDiv.style.display = 'none';
            });
        }

        function listenForPlanUpdates() {
            if (!plansCollectionRef) return;
            unsubscribePlans = onSnapshot(plansCollectionRef, (snapshot) => {
                allPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPlanSelector();
            });
        }

        function listenForScheduledCourseUpdates() {
            if (unsubscribeScheduledCourses) unsubscribeScheduledCourses();
            if (!currentPlanId) {
                scheduledCourses = [];
                renderSchedule();
                updatePlanCredits();
                loadingSchedulerDiv.style.display = 'none';
                return;
            }
            loadingSchedulerDiv.style.display = 'block';
            const scheduledCoursesRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`);
            unsubscribeScheduledCourses = onSnapshot(scheduledCoursesRef, (snapshot) => {
                scheduledCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule();
                updatePlanCredits();
                loadingSchedulerDiv.style.display = 'none';
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function renderCourses() {
            const selectedSemester = semesterFilter.value;
            const coursesToRender = selectedSemester === 'all' ? allCourses : allCourses.filter(c => c.semester === selectedSemester);
            courseListEl.innerHTML = '';
            if (coursesToRender.length === 0) {
                 courseListEl.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">No courses found.</td></tr>`;
                 return;
            }
            coursesToRender.sort((a,b) => (a.semester||'').localeCompare(b.semester||'') || (a.courseCode||'').localeCompare(b.courseCode||''));
            coursesToRender.forEach(c => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700/50';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-white">${c.courseCode||''}</td><td class="px-6 py-4">${c.courseName||''}</td><td class="px-6 py-4 text-center">${c.credits||0}</td><td class="px-6 py-4"><span class="font-semibold ${c.grade ? 'text-white' : 'text-yellow-400'}">${c.grade||'-'}</span></td><td class="px-6 py-4">${c.status||'In Progress'}</td><td class="px-6 py-4">${c.semester||''}</td><td class="px-6 py-4 text-right"><button data-id="${c.id}" class="edit-btn font-medium text-[#FDB719] hover:underline mr-3">Edit</button><button data-id="${c.id}" class="delete-btn font-medium text-red-500 hover:underline">Delete</button></td>`;
                courseListEl.appendChild(row);
            });
        }

        function renderSemesterTabs() {
            const inProgressSemesters = [...new Set(allCourses.filter(c => c.status === 'In Progress').map(c => c.semester))].sort();
            semesterTabsContainer.innerHTML = '';

            if (inProgressSemesters.length === 0) {
                planControls.classList.add('hidden');
                noInProgressSemestersMsg.classList.remove('hidden');
                activeSemester = null;
                currentPlanId = null;
                renderSchedule();
                return;
            }
            
            planControls.classList.remove('hidden');
            noInProgressSemestersMsg.classList.add('hidden');

            if (!activeSemester || !inProgressSemesters.includes(activeSemester)) {
                activeSemester = inProgressSemesters[0];
            }

            inProgressSemesters.forEach(semester => {
                const tab = document.createElement('button');
                tab.className = 'semester-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500';
                tab.textContent = semester;
                tab.dataset.semester = semester;
                if (semester === activeSemester) {
                    tab.classList.add('active');
                }
                tab.addEventListener('click', () => {
                    activeSemester = semester;
                    renderSemesterTabs();
                });
                semesterTabsContainer.appendChild(tab);
            });
            renderPlanSelector();
        }

        function renderPlanSelector() {
            if (!activeSemester) {
                planSelector.innerHTML = '<option>No semester selected</option>';
                currentPlanId = null;
                listenForScheduledCourseUpdates();
                return;
            }

            const plansForSemester = allPlans.filter(p => p.semester === activeSemester);
            planSelector.innerHTML = '';

            if (plansForSemester.length === 0) {
                planSelector.innerHTML = '<option>No plans yet</option>';
                currentPlanId = null;
            } else {
                plansForSemester.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = plan.name;
                    planSelector.appendChild(option);
                });
                currentPlanId = planSelector.value;
            }
            document.getElementById('deletePlanBtn').classList.toggle('hidden', plansForSemester.length === 0);
            listenForScheduledCourseUpdates();
        }
        
        function generateScheduleGrid() {
            scheduleGrid.innerHTML = '';
            scheduleGrid.innerHTML += `<div class="day-header text-gray-300"></div>` + DAYS.map(day => `<div class="day-header text-gray-300">${day}</div>`).join('');
            for (let hour = 7; hour < 21; hour++) {
                const timeLabelDiv = document.createElement('div');
                timeLabelDiv.className = 'time-label';
                timeLabelDiv.textContent = formatTimeAMPM(`${hour}:00`);
                timeLabelDiv.style.gridRow = (hour - 7) * 2 + 2;
                scheduleGrid.appendChild(timeLabelDiv);
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                    const cell1 = document.createElement('div');
                    cell1.className = 'grid-cell';
                    cell1.style.gridColumn = dayIndex + 2;
                    cell1.style.gridRow = (hour - 7) * 2 + 2;
                    
                    const cell2 = document.createElement('div');
                    cell2.className = 'grid-cell';
                    cell2.style.gridColumn = dayIndex + 2;
                    cell2.style.gridRow = (hour - 7) * 2 + 3;

                    scheduleGrid.appendChild(cell1);
                    scheduleGrid.appendChild(cell2);
                }
            }
        }

        function renderSchedule() {
            scheduleGrid.querySelectorAll('.course-block').forEach(el => el.remove());
            if (!currentPlanId) return;
            scheduledCourses.forEach(scheduledCourse => {
                const courseDetails = allCourses.find(c => c.id === scheduledCourse.courseId);
                if (!courseDetails) return;

                const start = timeToMinutes(courseDetails.startTime);
                const end = timeToMinutes(courseDetails.endTime);
                if (!courseDetails.startTime || !courseDetails.endTime || end <= start) return;
                
                const duration = end - start;
                const top = ((start - (7 * 60)) / 30) * 25 + 30;
                const height = (duration / 30) * 25;

                courseDetails.days.forEach(day => {
                    const dayIndex = DAYS.indexOf(day);
                    if (dayIndex === -1) return;
                    const bgColorClass = courseColorMap[courseDetails.id] || 'bg-gray-500';
                    const hexColor = tailwindToHex[bgColorClass] || '#6b7280';
                    const textColorClass = getTextColorForBg(hexColor);
                    const block = document.createElement('div');
                    block.className = `course-block ${bgColorClass} ${textColorClass}`;
                    block.style.top = `${top}px`;
                    block.style.height = `${height}px`;
                    block.style.left = `calc(60px + ${dayIndex} * (100% - 60px) / 5 + 2px)`;
                    block.style.width = `calc(((100% - 60px) / 5) - 4px)`;
                    block.innerHTML = `<strong class="block truncate">${courseDetails.courseCode} - ${courseDetails.courseName}</strong><p class="text-xs">${formatTimeAMPM(courseDetails.startTime)} - ${formatTimeAMPM(courseDetails.endTime)}</p>`;
                    block.dataset.id = scheduledCourse.id;
                    scheduleGrid.appendChild(block);
                });
            });
        }

        // --- CALCULATIONS & HELPERS ---
        function updatePlanCredits() {
            const uniqueCourseIds = [...new Set(scheduledCourses.map(sc => sc.courseId))];
            let totalPlanCredits = 0;
            uniqueCourseIds.forEach(courseId => {
                const courseDetails = allCourses.find(c => c.id === courseId);
                if (courseDetails && courseDetails.credits) {
                    totalPlanCredits += parseFloat(courseDetails.credits);
                }
            });
            planCreditsEl.textContent = totalPlanCredits;
        }

        function getTextColorForBg(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? 'text-black' : 'text-white';
        }

        function formatTimeAMPM(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minutes} ${ampm}`;
        }

        function calculateLawSchoolGpa(courses) {
            let totalPoints = 0;
            let creditsForGpa = 0;
            let creditsEarned = 0;

            courses.forEach(course => {
                const credits = parseFloat(course.credits) || 0;
                const grade = course.grade;
                const numericGrade = parseFloat(grade);

                if (!isNaN(numericGrade) && numericGrade >= 65) {
                    totalPoints += numericGrade * credits;
                    creditsForGpa += credits;
                }
                
                if ((!isNaN(numericGrade) && numericGrade >= 70) || grade === 'S') {
                    creditsEarned += credits;
                }
            });

            const gpa = creditsForGpa > 0 ? totalPoints / creditsForGpa : 0;
            return { gpa, creditsEarned, creditsForGpa };
        }

        function updateCalculations() {
            const selectedSemester = semesterFilter.value;
            
            const { gpa: cumulativeGpa, creditsEarned, creditsForGpa } = calculateLawSchoolGpa(allCourses);
            document.getElementById('cumulativeGpa').textContent = cumulativeGpa.toFixed(3);
            document.getElementById('totalCredits').textContent = creditsEarned;

            const semesterCourses = selectedSemester === 'all' ? allCourses : allCourses.filter(course => course.semester === selectedSemester);
            const { gpa: semesterGpa } = calculateLawSchoolGpa(semesterCourses);
            document.getElementById('semesterGpa').textContent = semesterGpa.toFixed(3);

            const gradStatusEl = document.getElementById('graduationStatus');
            if (cumulativeGpa > 76.999) {
                gradStatusEl.textContent = 'On Track';
                gradStatusEl.className = 'text-3xl font-bold text-teal-400';
            } else if (creditsForGpa > 0) {
                gradStatusEl.textContent = 'At Risk';
                gradStatusEl.className = 'text-3xl font-bold text-rose-400';
            } else {
                gradStatusEl.textContent = '-';
                gradStatusEl.className = 'text-3xl font-bold text-white';
            }
            
            updateBenchmarkDisplay(cumulativeGpa);
        }
        
        function updateBenchmarkDisplay(gpa) {
            const year = yearSelector.value;
            const yearBenchmarks = benchmarks[year];
            benchmarkDisplay.innerHTML = '';

            for (const [rank, value] of Object.entries(yearBenchmarks)) {
                const isAchieved = gpa >= value;
                const color = isAchieved ? 'text-teal-400' : 'text-rose-400';
                const div = document.createElement('div');
                div.className = `p-2 rounded-lg ${isAchieved ? 'bg-teal-900/50' : 'bg-rose-900/50'}`;
                div.innerHTML = `
                    <h4 class="text-sm font-semibold text-gray-300">${rank}</h4>
                    <p class="text-xl font-bold ${color}">${value}</p>
                    <p class="text-xs ${color}">${isAchieved ? '✓ Achieved' : '✗ Not Met'}</p>
                `;
                benchmarkDisplay.appendChild(div);
            }
        }

        function updateSemesterFilter() {
            const currentVal = semesterFilter.value;
            const semesters = [...new Set(allCourses.map(c => c.semester).filter(Boolean))].sort().reverse();
            while (semesterFilter.options.length > 1) { semesterFilter.remove(1); }
            semesters.forEach(semester => {
                const option = document.createElement('option');
                option.value = semester;
                option.textContent = semester;
                semesterFilter.appendChild(option);
            });
            if (semesters.includes(currentVal)) { semesterFilter.value = currentVal; }
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function updateCourseColorMap() {
            allCourses.forEach((course, index) => {
                if (!courseColorMap[course.id]) {
                    courseColorMap[course.id] = COLORS[index % COLORS.length];
                }
            });
        }

        function checkConflict(course1, course2) {
            if (!course1.days || !course2.days || !course1.startTime || !course2.startTime) return false;
            const hasCommonDay = course1.days.some(day => course2.days.includes(day));
            if (!hasCommonDay) return false;

            const start1 = timeToMinutes(course1.startTime);
            const end1 = timeToMinutes(course1.endTime);
            const start2 = timeToMinutes(course2.startTime);
            const end2 = timeToMinutes(course2.endTime);

            return start1 < end2 && end1 > start2;
        }

        // --- MODALS & FORMS ---
        function showCourseModal(course = null) {
            const form = document.getElementById('courseForm');
            form.reset();
            const gradeInput = document.getElementById('grade');
            const inProgressFields = document.getElementById('inProgressFields');
            const daysContainer = document.getElementById('courseDays');
            daysContainer.innerHTML = '';
            DAYS.forEach(day => {
                daysContainer.innerHTML += `<label class="flex items-center space-x-2"><input type="checkbox" name="days" value="${day}" class="rounded bg-gray-800 border-gray-600 text-[#FDB719] focus:ring-[#FDB719] accent-[#FDB719]"><span>${day.substring(0,3)}</span></label>`;
            });

            if (course) {
                document.getElementById('modalTitle').textContent = 'Edit Course';
                document.getElementById('courseId').value = course.id;
                document.getElementById('courseCode').value = course.courseCode;
                document.getElementById('courseName').value = course.courseName;
                document.getElementById('credits').value = course.credits;
                document.getElementById('courseStatus').value = course.status || 'In Progress';
                document.getElementById('grade').value = course.grade || '';
                document.getElementById('semester').value = course.semester;
                document.getElementById('startTime').value = course.startTime || '';
                document.getElementById('endTime').value = course.endTime || '';
                if (course.days) {
                    course.days.forEach(day => {
                        const checkbox = daysContainer.querySelector(`input[value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Add New Course';
                document.getElementById('courseId').value = '';
                document.getElementById('courseStatus').value = 'In Progress';
            }

            const status = document.getElementById('courseStatus').value;
            gradeInput.disabled = status === 'In Progress';
            gradeInput.classList.toggle('bg-gray-700', gradeInput.disabled);
            inProgressFields.style.display = status === 'In Progress' ? 'block' : 'none';

            courseModal.classList.remove('hidden');
        }
        function hideCourseModal() { courseModal.classList.add('hidden'); }
        
        function showPlanModal() {
            document.getElementById('planForm').reset();
            planModal.classList.remove('hidden');
        }
        function hidePlanModal() {
            planModal.classList.add('hidden');
        }

        function showChecklistModal() {
            renderChecklist();
            checklistModal.classList.remove('hidden');
        }
        function hideChecklistModal() {
            checklistModal.classList.add('hidden');
        }

        function renderChecklist() {
            checklistContainer.innerHTML = '';
            const availableCourses = allCourses.filter(c => c.status === 'In Progress' && c.semester === activeSemester);
            const scheduledCourseIds = new Set(scheduledCourses.map(sc => sc.courseId));
            const checkedCourses = allCourses.filter(c => scheduledCourseIds.has(c.id));

            availableCourses.forEach(course => {
                const isChecked = scheduledCourseIds.has(course.id);
                let hasConflict = false;
                if (!isChecked) {
                    for (const checkedCourse of checkedCourses) {
                        if (checkConflict(course, checkedCourse)) {
                            hasConflict = true;
                            break;
                        }
                    }
                }

                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${hasConflict ? 'bg-gray-800 text-gray-500' : 'bg-gray-700/50 border-gray-600'}`;
                const dayString = course.days && course.days.length > 0 ? course.days.map(d => d.substring(0,2)).join('') : 'N/A';
                const timeString = course.startTime && course.endTime ? `${formatTimeAMPM(course.startTime)} - ${formatTimeAMPM(course.endTime)}` : 'No time set';

                div.innerHTML = `
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" data-course-id="${course.id}" class="h-5 w-5 rounded border-gray-500 bg-gray-800 text-[#FDB719] focus:ring-[#FDB719] accent-[#FDB719]" ${isChecked ? 'checked' : ''} ${hasConflict ? 'disabled' : ''}>
                        <div>
                            <p class="font-semibold ${hasConflict ? '' : 'text-white'}">${course.courseCode} - ${course.courseName}</p>
                            <p class="text-sm ${hasConflict ? '' : 'text-gray-300'}">${dayString} | ${timeString}</p>
                        </div>
                    </label>
                `;
                checklistContainer.appendChild(div);
            });

            checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const courseId = e.target.dataset.courseId;
                    if (e.target.checked) {
                        const scheduleDocRef = collection(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`);
                        await addDoc(scheduleDocRef, { courseId: courseId });
                    } else {
                        const docToDelete = scheduledCourses.find(sc => sc.courseId === courseId);
                        if (docToDelete) {
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedulePlans/${currentPlanId}/scheduledCourses`, docToDelete.id));
                        }
                    }
                    renderChecklist(); // Re-render to update conflicts
                });
            });
        }

        // --- EVENT LISTENERS ---
        yearSelector.addEventListener('change', () => updateCalculations());
        tabCourses.addEventListener('click', () => {
            document.getElementById('view-courses').classList.remove('hidden');
            document.getElementById('view-scheduler').classList.add('hidden');
            tabCourses.classList.remove('border-transparent', 'text-[#989898]', 'hover:text-[#D4D4D4]', 'hover:border-gray-500');
            tabCourses.classList.add('border-[#FDB719]', 'text-[#FDB719]');
            tabScheduler.classList.add('border-transparent', 'text-[#989898]', 'hover:text-[#D4D4D4]', 'hover:border-gray-500');
            tabScheduler.classList.remove('border-[#FDB719]', 'text-[#FDB719]');
        });
        tabScheduler.addEventListener('click', () => {
            document.getElementById('view-courses').classList.add('hidden');
            document.getElementById('view-scheduler').classList.remove('hidden');
            tabScheduler.classList.remove('border-transparent', 'text-[#989898]', 'hover:text-[#D4D4D4]', 'hover:border-gray-500');
            tabScheduler.classList.add('border-[#FDB719]', 'text-[#FDB719]');
            tabCourses.classList.add('border-transparent', 'text-[#989898]', 'hover:text-[#D4D4D4]', 'hover:border-gray-500');
            tabCourses.classList.remove('border-[#FDB719]', 'text-[#FDB719]');
        });

        document.getElementById('courseStatus').addEventListener('change', (e) => {
            const gradeInput = document.getElementById('grade');
            const inProgressFields = document.getElementById('inProgressFields');
            const isDisabled = e.target.value !== 'Complete';
            gradeInput.disabled = isDisabled;
            gradeInput.classList.toggle('bg-gray-700', isDisabled);
            inProgressFields.style.display = !isDisabled ? 'none' : 'block';
            if (isDisabled) {
                gradeInput.value = '';
            } else {
                 document.getElementById('startTime').value = '';
                 document.getElementById('endTime').value = '';
                 document.querySelectorAll('#courseDays input').forEach(cb => cb.checked = false);
            }
        });

        document.getElementById('addCourseBtn').addEventListener('click', () => showCourseModal());
        document.getElementById('cancelBtn').addEventListener('click', hideCourseModal);
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            const status = document.getElementById('courseStatus').value;
            const gradeInput = document.getElementById('grade').value.trim().toUpperCase();
            
            if (status === 'Complete') {
                const numericGrade = parseFloat(gradeInput);
                let isValid = false;
                if (gradeInput === 'S' || gradeInput === 'U' || (!isNaN(numericGrade) && numericGrade >= 65 && numericGrade <= 100)) {
                    isValid = true;
                }
                if (!isValid) {
                    alert('For a complete course, please enter a valid grade (65-100, S, or U).');
                    return;
                }
            }
            const selectedDays = Array.from(document.querySelectorAll('#courseDays input:checked')).map(cb => cb.value);

            const courseData = { 
                courseCode: document.getElementById('courseCode').value, 
                courseName: document.getElementById('courseName').value, 
                credits: parseFloat(document.getElementById('credits').value) || 0, 
                status: status,
                grade: status === 'Complete' ? gradeInput : '', 
                semester: document.getElementById('semester').value,
                days: status === 'In Progress' ? selectedDays : [],
                startTime: status === 'In Progress' ? document.getElementById('startTime').value : '',
                endTime: status === 'In Progress' ? document.getElementById('endTime').value : '',
            };
            const courseId = document.getElementById('courseId').value;
            try {
                if (courseId) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/courses`, courseId), courseData);
                } else {
                    await addDoc(coursesCollectionRef, courseData);
                }
                hideCourseModal();
            } catch (error) { console.error("Error saving course: ", error); }
        });
        courseListEl.addEventListener('click', async (e) => {
            if (!userId) return;
            const target = e.target;
            const id = target.dataset.id;
            if (target.classList.contains('edit-btn')) {
                const course = allCourses.find(c => c.id === id);
                if (course) showCourseModal(course);
            }
            if (target.classList.contains('delete-btn')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/courses`, id));
                } catch (error) { console.error("Error deleting course: ", error); }
            }
        });
        semesterFilter.addEventListener('change', () => {
            renderCourses();
            updateCalculations();
        });

        document.getElementById('manageScheduleBtn').addEventListener('click', showChecklistModal);
        document.getElementById('closeChecklistBtn').addEventListener('click', hideChecklistModal);
        
        document.getElementById('addPlanBtn').addEventListener('click', showPlanModal);
        document.getElementById('cancelPlanBtn').addEventListener('click', hidePlanModal);
        document.getElementById('planForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activeSemester) {
                alert("Please select a semester tab first.");
                return;
            }
            const planNameInput = document.getElementById('planName');
            const planName = planNameInput.value.trim();
            if (planName && plansCollectionRef) {
                try {
                    const newPlan = await addDoc(plansCollectionRef, { name: planName, semester: activeSemester });
                    currentPlanId = newPlan.id;
                    hidePlanModal();
                } catch (error) {
                    console.error("Error creating new plan:", error);
                }
            }
        });

        document.getElementById('deletePlanBtn').addEventListener('click', async () => {
            if (!currentPlanId) return;
            if (confirm("Are you sure you want to delete this plan? This cannot be undone.")) {
                 try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedulePlans`, currentPlanId));
                    currentPlanId = null; 
                } catch (error) { console.error("Error deleting plan:", error); }
            }
        });
        planSelector.addEventListener('change', () => {
            currentPlanId = planSelector.value;
            listenForScheduledCourseUpdates();
        });
        
        // --- INITIAL LOAD ---
        initializeFirebase();
        generateScheduleGrid();
    </script>
</body>
</html>
