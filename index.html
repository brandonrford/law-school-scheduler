<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* For Webkit browsers like Chrome, Safari */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .day-column {
            background-image: linear-gradient(to bottom, rgba(128, 128, 128, 0.1) 1px, transparent 1px);
            background-size: 100% 80px; /* 80px represents 1 hour */
        }
        /* Toggle Switch CSS */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3b82f6; /* blue-500 for Task */
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #8b5cf6; /* purple-500 for Course */
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-900 text-gray-100" style="background-image: url(https://www.transparenttextures.com/patterns/stardust.png)">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-black bg-opacity-25 backdrop-blur-lg rounded-2xl border border-gray-700 shadow-lg">
            <div class="text-center">
                <h1 class="text-4xl font-bold">Personal Dashboard</h1>
                <p class="mt-2 text-blue-400">Your universe, organized.</p>
            </div>
            <button id="login-button" class="w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all duration-300">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Sign In with Google
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold">Your Personal Dashboard</h1>
                <p id="welcome-message" class="text-sm text-gray-400"></p>
            </div>
            <button id="logout-button" class="w-auto px-4 py-2 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all duration-300">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Logout</span>
            </button>
        </header>
        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Course Schedule -->
            <div id="course-schedule-widget" class="lg:col-span-3"></div>
            <!-- Task Tracker -->
            <div id="task-tracker-widget" class="md:col-span-2 lg:col-span-1"></div>
            <!-- Job Application Center -->
            <div id="job-app-widget" class="md:col-span-2 lg:col-span-2"></div>
            <!-- Journal & Goals -->
            <div id="journal-goals-widget" class="lg:col-span-3"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ICON REPLACEMENT ---
        lucide.createIcons();

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // This will be replaced by the middleware function on Cloudflare
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'personal-dashboard-static';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');

        // --- AUTHENTICATION ---
        loginButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
            }
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                welcomeMessage.textContent = `Welcome, ${user.displayName || 'User'}`;
                initDashboard(user.uid);
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
            lucide.createIcons();
        });

        // --- WIDGETS ---
        const createWidget = (title, icon, content, startOpen = false) => {
            const widgetId = `widget-${Math.random().toString(36).substr(2, 9)}`;
            let isOpen = startOpen;
            const html = `
                <div class="bg-black bg-opacity-25 backdrop-blur-lg rounded-2xl border border-gray-700 shadow-lg p-6">
                    <button id="toggle-${widgetId}" class="w-full flex justify-between items-center text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${icon}" class="text-purple-400"></i>
                            <h2 class="text-xl font-bold">${title}</h2>
                        </div>
                        <i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}"></i>
                    </button>
                    <div id="content-${widgetId}" class="mt-4 pt-4 border-t border-gray-700 ${isOpen ? '' : 'hidden'}">
                        ${content}
                    </div>
                </div>
            `;

            const toggle = (el) => {
                isOpen = !isOpen;
                document.getElementById(`content-${widgetId}`).classList.toggle('hidden');
                document.getElementById(`toggle-${widgetId}`).querySelector('[data-lucide]').outerHTML = `<i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}"></i>`;
                lucide.createIcons();
            };
            
            return { html, id: widgetId, toggle };
        };
        
        function initDashboard(userId) {
            initCourseSchedule(userId);
            initTaskTracker(userId);
            initJobAppCenter(userId);
            initJournalAndGoals(userId);
        }

        // 1. Course Schedule
        function initCourseSchedule(userId) {
            const container = document.getElementById('course-schedule-widget');
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            const scheduleCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'schedule');
            const scheduleStartHour = 8; // 8 AM
            const scheduleEndHour = 17; // 5 PM (17:00)
            const hourHeight = 80; // pixels per hour
            
            const dayAbbreviations = { Monday: 'M', Tuesday: 'T', Wednesday: 'W', Thursday: 'Th', Friday: 'F' };

            const formContent = `
                <form id="add-course-form" class="flex flex-wrap gap-4 mb-6 items-end">
                    <div class="flex-grow min-w-[200px]">
                        <label for="courseName" class="text-xs font-semibold text-gray-400">Event Name</label>
                        <input type="text" id="courseName" name="name" placeholder="e.g. Quantum Physics" class="w-full mt-1 p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    </div>
                    <div class="flex-grow min-w-[150px]">
                        <label for="courseRoom" class="text-xs font-semibold text-gray-400">Location / Room</label>
                        <input type="text" id="courseRoom" name="room" placeholder="e.g. Hall C" class="w-full mt-1 p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" />
                    </div>
                    <div class="flex-grow min-w-[200px]">
                        <label class="text-xs font-semibold text-gray-400">Start & End Time</label>
                        <div class="flex gap-2 mt-1">
                            <input type="time" name="startTime" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                            <input type="time" name="endTime" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                        </div>
                    </div>
                     <div class="w-full flex flex-wrap items-center justify-between gap-x-4 gap-y-2 pt-4">
                        <div class="flex items-center gap-x-4">
                            <span class="font-semibold text-sm">Days:</span>
                            ${days.map(day => `
                                <label class="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" name="day" value="${day}" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                    ${dayAbbreviations[day]}
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-semibold text-sm text-blue-400">Task</span>
                            <label class="toggle-switch">
                                <input type="checkbox" name="typeToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="font-semibold text-sm text-purple-400">Course</span>
                        </div>
                    </div>
                    <div class="w-full">
                         <button type="submit" class="mt-2 h-12 w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2">Add to Schedule</button>
                    </div>
                </form>
            `;

            const scheduleGridContent = `
                <div class="overflow-x-auto">
                    <div class="relative grid grid-cols-[auto_1fr_1fr_1fr_1fr_1fr] text-sm text-center font-bold min-w-[640px]">
                        <div></div> <!-- Empty corner -->
                        ${days.map(day => `<div class="p-2 border-b-2 border-gray-600">${day}</div>`).join('')}
                    </div>
                    <div class="relative grid grid-cols-[auto_1fr_1fr_1fr_1fr_1fr] h-[${(scheduleEndHour - scheduleStartHour) * hourHeight}px] min-w-[640px]">
                        <!-- Time Labels -->
                        <div class="relative -top-3 pr-2 text-right text-xs text-gray-400">
                            ${Array.from({length: scheduleEndHour - scheduleStartHour + 1}, (_, i) => `<div style="height: ${hourHeight}px;">${(scheduleStartHour + i) % 12 || 12} ${scheduleStartHour + i < 12 || scheduleStartHour + i === 24 ? 'AM' : 'PM'}</div>`).slice(0, -1).join('')}
                        </div>
                        <!-- Day Columns -->
                        ${days.map(day => `<div id="schedule-col-${day}" class="day-column relative border-l border-gray-700"></div>`).join('')}
                    </div>
                </div>
            `;

            const widget = createWidget('Course Schedule', 'book-open', formContent + scheduleGridContent, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById('add-course-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedDays = Array.from(form.querySelectorAll('input[name="day"]:checked')).map(cb => cb.value);
                if (selectedDays.length === 0) {
                    alert('Please select at least one day.');
                    return;
                }
                const courseGroupId = `course_${Date.now()}`;
                const type = form.typeToggle.checked ? 'Course' : 'Task';
                const batch = writeBatch(db);
                selectedDays.forEach(day => {
                    const newCourseRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'schedule'));
                    batch.set(newCourseRef, {
                        name: form.name.value,
                        room: form.room.value,
                        startTime: form.startTime.value,
                        endTime: form.endTime.value,
                        day: day,
                        groupId: courseGroupId,
                        type: type
                    });
                });
                await batch.commit();
                form.reset();
            });

            onSnapshot(scheduleCollectionRef, (snapshot) => {
                // Clear existing blocks
                days.forEach(day => document.getElementById(`schedule-col-${day}`).innerHTML = '');

                snapshot.docs.forEach(docSnap => {
                    const course = { id: docSnap.id, ...docSnap.data() };
                    if (!course.startTime || !course.endTime) return;
                    
                    const start = new Date(`1970-01-01T${course.startTime}`);
                    const end = new Date(`1970-01-01T${course.endTime}`);
                    
                    const startMinutes = (start.getHours() * 60 + start.getMinutes()) - (scheduleStartHour * 60);
                    const endMinutes = (end.getHours() * 60 + end.getMinutes()) - (scheduleStartHour * 60);

                    const duration = endMinutes - startMinutes;

                    if (duration <= 0) return;

                    const bgColor = course.type === 'Course' ? 'bg-purple-800' : 'bg-blue-800';
                    const borderColor = course.type === 'Course' ? 'border-purple-400' : 'border-blue-400';

                    const courseBlock = document.createElement('div');
                    courseBlock.className = `absolute w-full p-2 text-left ${bgColor} bg-opacity-70 border-l-4 ${borderColor} rounded-r-lg overflow-hidden flex flex-col`;
                    courseBlock.style.top = `${startMinutes * (hourHeight / 60)}px`;
                    courseBlock.style.height = `${duration * (hourHeight / 60)}px`;
                    
                    const formattedStartTime = start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const formattedEndTime = end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    courseBlock.innerHTML = `
                        <p class="font-bold text-xs">${course.name}</p>
                        <p class="text-xs text-gray-300">${formattedStartTime} - ${formattedEndTime}</p>
                        ${course.room ? `<p class="text-xs text-gray-300 mt-1">Room: ${course.room}</p>` : ''}
                        <button class="delete-course absolute top-1 right-1" data-group-id="${course.groupId}">
                            <i data-lucide="trash-2" class="w-3 h-3 text-red-400 hover:text-red-300"></i>
                        </button>
                    `;
                    
                    const dayColumn = document.getElementById(`schedule-col-${course.day}`);
                    if (dayColumn) {
                        dayColumn.appendChild(courseBlock);
                    }
                });
                
                document.querySelectorAll('.delete-course').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const groupId = e.currentTarget.dataset.groupId;
                        if (!confirm('Delete this event from all scheduled days?')) return;
                        
                        const q = query(scheduleCollectionRef, where("groupId", "==", groupId));
                        const querySnapshot = await getDocs(q);
                        const deleteBatch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            deleteBatch.delete(doc.ref);
                        });
                        await deleteBatch.commit();
                    });
                });
                lucide.createIcons();
            });
        }
        
        // 2. Task Tracker
        function initTaskTracker(userId) {
            const container = document.getElementById('task-tracker-widget');
            const tasksCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            let showArchived = false;

            const content = `
                <form id="add-task-form" class="flex gap-2 mb-4">
                    <input type="text" name="text" placeholder="New task..." class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <button type="submit" class="w-auto px-4 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </form>
                <div id="task-lists"></div>
            `;
            const widget = createWidget('Task Tracker', 'check', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById('add-task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(tasksCollectionRef, { text: form.text.value, done: false });
                form.reset();
            });

            onSnapshot(tasksCollectionRef, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activeTasks = tasks.filter(t => !t.done);
                const archivedTasks = tasks.filter(t => t.done);
                const taskLists = document.getElementById('task-lists');

                taskLists.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="font-bold mb-2">To-Do</h3>
                        <ul class="space-y-2">
                            ${activeTasks.map(task => `
                                <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                                    <button class="toggle-task" data-id="${task.id}" data-done="${task.done}"><div class="w-5 h-5 rounded border-2 border-gray-500"></div></button>
                                    <span>${task.text}</span>
                                    <button class="delete-task ml-auto" data-id="${task.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                                </li>
                            `).join('')}
                        </ul>
                        <div>
                            <button id="toggle-archive" class="font-bold mb-2 flex items-center gap-2">
                                <i data-lucide="archive" class="w-4 h-4"></i> Archived (${archivedTasks.length}) <i data-lucide="${showArchived ? 'chevron-up' : 'chevron-down'}"></i>
                            </button>
                            <ul id="archive-list" class="space-y-2 mt-2 ${showArchived ? '' : 'hidden'}">
                                ${archivedTasks.map(task => `
                                    <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                                        <button class="toggle-task" data-id="${task.id}" data-done="${task.done}"><div class="w-5 h-5 rounded border-2 bg-purple-500 border-purple-500 flex items-center justify-center"><i data-lucide="check" class="w-4 h-4"></i></div></button>
                                        <span class="line-through text-gray-500">${task.text}</span>
                                        <button class="delete-task ml-auto" data-id="${task.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('toggle-archive').addEventListener('click', () => {
                    showArchived = !showArchived;
                    document.getElementById('archive-list').classList.toggle('hidden');
                    document.querySelector('#toggle-archive [data-lucide]').outerHTML = `<i data-lucide="${showArchived ? 'chevron-up' : 'chevron-down'}"></i>`;
                    lucide.createIcons();
                });

                taskLists.querySelectorAll('.toggle-task').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const done = e.currentTarget.dataset.done === 'true';
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', id), { done: !done });
                }));
                taskLists.querySelectorAll('.delete-task').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', id));
                }));
                lucide.createIcons();
            });
        }

        // 3. Job Application Center
        function initJobAppCenter(userId) {
            const container = document.getElementById('job-app-widget');
            const appsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'job_applications');
            const statuses = ["Applied", "Interviewing", "Offer", "Rejected"];

            const getStatusColor = (status) => {
                const colors = {
                    'Offer': 'bg-green-500 text-green-900',
                    'Interviewing': 'bg-blue-500 text-blue-900',
                    'Applied': 'bg-yellow-500 text-yellow-900',
                    'Rejected': 'bg-red-500 text-red-900'
                };
                return colors[status] || 'bg-gray-500 text-gray-900';
            };

            const content = `
                <form id="add-app-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input type="text" name="company" placeholder="Company" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <input type="text" name="position" placeholder="Position" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <button type="submit" class="sm:col-span-2 w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2">Add Application</button>
                </form>
                <div id="app-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            `;
            const widget = createWidget('Job Application Center', 'briefcase', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById('add-app-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(appsCollectionRef, {
                    company: form.company.value,
                    position: form.position.value,
                    status: 'Applied',
                    date: new Date().toISOString().split('T')[0]
                });
                form.reset();
            });

            onSnapshot(query(appsCollectionRef, orderBy("date", "desc")), (snapshot) => {
                const appList = document.getElementById('app-list');
                appList.innerHTML = snapshot.docs.map(docSnap => {
                    const app = { id: docSnap.id, ...docSnap.data() };
                    return `
                        <div class="p-3 bg-gray-800 bg-opacity-40 rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <div>
                                <p class="font-bold flex items-center gap-2"><i data-lucide="building" class="w-4 h-4"></i> ${app.company}</p>
                                <p class="text-sm text-gray-300">${app.position}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <select class="update-status text-xs p-2 w-auto rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 font-bold ${getStatusColor(app.status)}" data-id="${app.id}">
                                    ${statuses.map(s => `<option value="${s}" ${s === app.status ? 'selected' : ''} class="bg-gray-800 text-white">${s}</option>`).join('')}
                                </select>
                                <p class="text-xs text-gray-400"><i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>${app.date}</p>
                                <button class="delete-app" data-id="${app.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                appList.querySelectorAll('.update-status').forEach(select => select.addEventListener('change', async (e) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'job_applications', e.target.dataset.id), { status: e.target.value });
                }));
                appList.querySelectorAll('.delete-app').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'job_applications', e.currentTarget.dataset.id));
                }));
                lucide.createIcons();
            });
        }

        // 4. Journal & Goals
        function initJournalAndGoals(userId) {
            const container = document.getElementById('journal-goals-widget');
            const goalsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'goals');
            const journalCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'journal_entries');

            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Goals -->
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="target" class="text-blue-400"></i> Long-Term Goals</h3>
                        <form id="add-goal-form" class="flex gap-2 mb-4">
                            <input type="text" name="text" placeholder="New goal..." class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                            <button type="submit" class="w-auto px-4 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2"><i data-lucide="plus"></i></button>
                        </form>
                        <ul id="goal-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>
                    <!-- Journal -->
                    <div>
                        <h3 class="text-lg font-bold mb-3">Daily Entry</h3>
                        <form id="add-entry-form">
                            <textarea name="text" placeholder="What's on your mind?" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 h-32 resize-none mb-2" required></textarea>
                            <button type="submit" class="w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold">Save Entry</button>
                        </form>
                        <div id="entry-list" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            `;
            const widget = createWidget('Journal & Goals', 'edit-3', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            // Goals Logic
            document.getElementById('add-goal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(goalsCollectionRef, { text: form.text.value, done: false });
                form.reset();
            });
            onSnapshot(goalsCollectionRef, snapshot => {
                const goalList = document.getElementById('goal-list');
                goalList.innerHTML = snapshot.docs.map(docSnap => {
                    const goal = { id: docSnap.id, ...docSnap.data() };
                    return `
                        <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                            <button class="toggle-goal" data-id="${goal.id}" data-done="${goal.done}"><div class="w-5 h-5 rounded-full border-2 ${goal.done ? 'bg-purple-500 border-purple-500' : 'border-gray-500'} flex items-center justify-center">${goal.done ? '<i data-lucide="star" class="w-3 h-3"></i>' : ''}</div></button>
                            <span class="${goal.done ? 'line-through text-gray-500' : ''}">${goal.text}</span>
                            <button class="delete-goal ml-auto" data-id="${goal.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                        </li>
                    `;
                }).join('');
                goalList.querySelectorAll('.toggle-goal').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const done = e.currentTarget.dataset.done === 'true';
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'goals', id), { done: !done });
                }));
                goalList.querySelectorAll('.delete-goal').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'goals', id));
                }));
                lucide.createIcons();
            });

            // Journal Logic
            document.getElementById('add-entry-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(journalCollectionRef, {
                    text: form.text.value,
                    date: new Date().toISOString().split('T')[0]
                });
                form.reset();
            });
            onSnapshot(query(journalCollectionRef, orderBy("date", "desc")), snapshot => {
                const entryList = document.getElementById('entry-list');
                entryList.innerHTML = snapshot.docs.map(docSnap => {
                    const entry = { id: docSnap.id, ...docSnap.data() };
                    return `
                        <div class="p-3 bg-gray-800 bg-opacity-40 rounded-lg">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-xs font-semibold text-purple-300">${new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                                <button class="delete-entry" data-id="${entry.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                            </div>
                            <p class="text-sm whitespace-pre-wrap">${entry.text}</p>
                        </div>
                    `;
                }).join('');
                entryList.querySelectorAll('.delete-entry').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'journal_entries', e.currentTarget.dataset.id));
                }));
                lucide.createIcons();
            });
            lucide.createIcons();
        }

    </script>
</body>
</html>
