<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard</title>
    <!-- 
      PRODUCTION NOTE: The Tailwind CSS CDN script below is great for development but not recommended 
      for production due to performance. For a live website, you should install Tailwind CSS
      and generate a static CSS file.
      See how: https://tailwindcss.com/docs/installation
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url(https://www.transparenttextures.com/patterns/stardust.png);
            background-attachment: fixed; /* This creates the simple parallax effect */
            background-position: center;
        }
        /* For Webkit browsers like Chrome, Safari */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .day-column {
            background-image: linear-gradient(to bottom, rgba(128, 128, 128, 0.1) 1px, transparent 1px);
            background-size: 100% 100px; /* 100px represents 1 hour */
        }
        /* Toggle Switch CSS */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3b82f6; /* blue-500 for Misc */
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #8b5cf6; /* purple-500 for Class */
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for rendered Markdown content */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2; }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose p { margin-bottom: 1em; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose a { color: #818cf8; text-decoration: underline; }
        .prose code { background-color: #1f2937; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
        .prose pre { background-color: #1f2937; padding: 1em; border-radius: 8px; overflow-x: auto; }
        .prose blockquote { border-left: 4px solid #4a5568; padding-left: 1em; margin-left: 0; color: #a0aec0; }
        .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        .prose th, .prose td { border: 1px solid #4a5568; padding: 0.5em 1em; }
        .prose th { font-weight: bold; background-color: #2d3748; }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-black bg-opacity-25 backdrop-blur-lg rounded-2xl border border-gray-700 shadow-lg">
            <div class="text-center">
                <h1 class="text-4xl font-bold">Personal Dashboard</h1>
                <p class="mt-2 text-pink-400">Your case, organized.</p>
            </div>
            <button id="login-button" class="w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all duration-300">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Sign In with Google
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold">Your Personal Dashboard</h1>
                <p id="welcome-message" class="text-sm text-gray-400"></p>
            </div>
            <button id="logout-button" class="w-auto px-4 py-2 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all duration-300">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Logout</span>
            </button>
        </header>
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Course Schedule -->
            <div id="course-schedule-widget" class="lg:col-span-3"></div>
            <!-- Task Tracker -->
            <div id="task-tracker-widget" class="lg:col-span-1"></div>
            <!-- Job Application Center -->
            <div id="job-app-widget" class="lg:col-span-2"></div>
            <!-- Journal & Goals -->
            <div id="journal-goals-widget" class="lg:col-span-3"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ICON REPLACEMENT ---
        lucide.createIcons();

        // --- FIREBASE CONFIGURATION ---
        // This configuration is injected by the environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // This will be replaced by the middleware function on Cloudflare
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'personal-dashboard-static';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- GLOBAL CONFIGURATION ---
        const CLOUDFLARE_WORKER_URL = "https://gemini-worker.brandonford227.workers.dev";

        // --- UI ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');

        // --- AUTHENTICATION ---
        loginButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
            }
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                welcomeMessage.textContent = `Welcome, ${user.displayName || 'User'}`;
                initDashboard(user.uid);
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
            lucide.createIcons();
        });

        // --- WIDGETS ---
        const createWidget = (title, icon, content, startOpen = false) => {
            const widgetId = `widget-${Math.random().toString(36).substr(2, 9)}`;
            let isOpen = startOpen;
            const html = `
                <div class="bg-black bg-opacity-25 backdrop-blur-lg rounded-2xl border border-gray-700 shadow-lg p-6">
                    <button id="toggle-${widgetId}" class="w-full flex justify-between items-center text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${icon}" class="text-purple-400"></i>
                            <h2 class="text-xl font-bold">${title}</h2>
                        </div>
                        <i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}" class="toggle-chevron"></i>
                    </button>
                    <div id="content-${widgetId}" class="mt-4 pt-4 border-t border-gray-700 ${isOpen ? '' : 'hidden'}">
                        ${content}
                    </div>
                </div>
            `;

            const toggle = (el) => {
                isOpen = !isOpen;
                document.getElementById(`content-${widgetId}`).classList.toggle('hidden');
                const chevron = document.getElementById(`toggle-${widgetId}`).querySelector('.toggle-chevron');
                if (chevron) {
                    chevron.outerHTML = `<i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}" class="toggle-chevron"></i>`;
                }
                lucide.createIcons();
            };
            
            return { html, id: widgetId, toggle };
        };
        
        function initDashboard(userId) {
            // A map to ensure widgets are only initialized once
            if (!window.dashboardInitialized) {
                window.dashboardInitialized = new Set();
            }

            if (!window.dashboardInitialized.has(userId)) {
                initCourseSchedule(userId);
                initTaskTracker(userId);
                initJobAppCenter(userId);
                initJournalAndGoals(userId);
                window.dashboardInitialized.add(userId);
            }
        }

        // 1. Course Schedule
        function initCourseSchedule(userId) {
            const container = document.getElementById('course-schedule-widget');
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            const scheduleCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'schedule');
            const scheduleStartHour = 8; // 8 AM
            const scheduleEndHour = 17; // 5 PM (17:00)
            const hourHeight = 100; // pixels per hour
            
            const dayAbbreviations = { Monday: 'M', Tuesday: 'T', Wednesday: 'W', Thursday: 'Th', Friday: 'F' };

            // --- STATE FOR SCHEDULE ---
            let currentSemester = 'fall2025';
            let scheduleUnsubscribe = null;

            const semesterSelector = `
                <div class="flex justify-center gap-2 mb-4" id="semester-selector-${userId}">
                    <button data-semester="fall2025" class="semester-btn w-full p-2 rounded-lg font-bold bg-purple-600 transition-colors">Fall 2025</button>
                    <button data-semester="spring2026" class="semester-btn w-full p-2 rounded-lg font-bold bg-gray-700 hover:bg-gray-600 transition-colors">Spring 2026</button>
                </div>
            `;

            const formContent = `
                <form id="add-course-form-${userId}" class="flex flex-wrap gap-4 mb-6 items-end">
                    <div class="flex-grow min-w-[150px] sm:min-w-[200px]">
                        <label for="courseName" class="text-xs font-semibold text-gray-400">Class / Event Name</label>
                        <input type="text" id="courseName" name="name" placeholder="e.g. Torts" class="w-full mt-1 p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    </div>
                    <div class="flex-grow min-w-[150px]">
                        <label for="courseRoom" class="text-xs font-semibold text-gray-400">Location / Room #</label>
                        <input type="text" id="courseRoom" name="room" placeholder="e.g. Hulston 103" class="w-full mt-1 p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" />
                    </div>
                    <div class="flex-grow min-w-[200px]">
                        <label class="text-xs font-semibold text-gray-400">Start & End Time</label>
                        <div class="flex gap-2 mt-1">
                            <input type="time" name="startTime" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                            <input type="time" name="endTime" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                        </div>
                    </div>
                     <div class="w-full flex flex-wrap items-center justify-between gap-x-4 gap-y-2 pt-4">
                        <div class="flex items-center gap-x-4">
                            <span class="font-semibold text-sm">Days:</span>
                            ${days.map(day => `
                                <label class="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" name="day" value="${day}" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                    ${dayAbbreviations[day]}
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-semibold text-sm text-blue-400">Misc</span>
                            <label class="toggle-switch">
                                <input type="checkbox" name="typeToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="font-semibold text-sm text-purple-400">Class</span>
                        </div>
                    </div>
                    <div class="w-full">
                         <button type="submit" class="mt-2 h-12 w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2">Add to Calendar</button>
                    </div>
                </form>
            `;

            const scheduleGridContent = `
                <div class="overflow-x-auto">
                    <div class="grid grid-cols-[auto_1fr_1fr_1fr_1fr_1fr] text-sm text-center font-bold min-w-[640px]">
                        <div class="w-12"></div> <!-- Empty corner -->
                        ${days.map(day => `<div class="p-2 border-b-2 border-gray-600">${day}</div>`).join('')}
                    </div>
                    <div class="relative grid grid-cols-[auto_1fr_1fr_1fr_1fr_1fr] min-w-[640px]" style="height: ${(scheduleEndHour - scheduleStartHour) * hourHeight}px;">
                        <!-- Time Labels -->
                        <div class="relative w-12 h-full">
                            ${Array.from({length: scheduleEndHour - scheduleStartHour + 1}, (_, i) => {
                                const hour = scheduleStartHour + i;
                                const displayHour = hour % 12 || 12;
                                const ampm = hour < 12 || hour === 24 ? 'AM' : 'PM';
                                return `<div class="absolute text-xs text-gray-400 text-right w-full pr-2" style="top: ${i * hourHeight - 8}px;">${displayHour} ${ampm}</div>`;
                            }).join('')}
                        </div>
                        <!-- Day Columns -->
                        ${days.map(day => `<div id="schedule-col-${day}-${userId}" class="day-column relative border-l border-gray-700 h-full"></div>`).join('')}
                    </div>
                </div>
            `;

            const widget = createWidget('Class Schedule', 'book-open', semesterSelector + formContent + scheduleGridContent, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById(`add-course-form-${userId}`).addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const selectedDays = Array.from(form.querySelectorAll('input[name="day"]:checked')).map(cb => cb.value);
                if (selectedDays.length === 0) {
                    alert('Please select at least one day.');
                    return;
                }
                const courseGroupId = `course_${Date.now()}`;
                const type = form.typeToggle.checked ? 'Class' : 'Misc';
                const batch = writeBatch(db);
                selectedDays.forEach(day => {
                    const newCourseRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'schedule'));
                    batch.set(newCourseRef, {
                        name: form.name.value,
                        room: form.room.value,
                        startTime: form.startTime.value,
                        endTime: form.endTime.value,
                        day: day,
                        groupId: courseGroupId,
                        type: type,
                        semester: currentSemester // Add semester field
                    });
                });
                await batch.commit();
                form.reset();
            });

            function setupScheduleListener() {
                if (scheduleUnsubscribe) {
                    scheduleUnsubscribe();
                }
                
                const q = query(scheduleCollectionRef);

                scheduleUnsubscribe = onSnapshot(q, (snapshot) => {
                    // Clear existing blocks
                    days.forEach(day => document.getElementById(`schedule-col-${day}-${userId}`).innerHTML = '');

                    snapshot.docs.forEach(docSnap => {
                        const course = { id: docSnap.id, ...docSnap.data() };
                        
                        // Filter for the current semester
                        const courseSemester = course.semester || 'fall2025'; // Default to fall2025 if not set
                        if (courseSemester !== currentSemester) return;

                        if (!course.startTime || !course.endTime) return;
                        
                        const start = new Date(`1970-01-01T${course.startTime}`);
                        const end = new Date(`1970-01-01T${course.endTime}`);
                        
                        const startMinutes = (start.getHours() * 60 + start.getMinutes()) - (scheduleStartHour * 60);
                        const endMinutes = (end.getHours() * 60 + end.getMinutes()) - (scheduleStartHour * 60);

                        const duration = endMinutes - startMinutes;

                        if (duration <= 0) return;
                        
                        const isClass = course.type !== 'Misc';
                        const bgColor = isClass ? 'bg-purple-800' : 'bg-blue-800';
                        const borderColor = isClass ? 'border-purple-400' : 'border-blue-400';

                        const courseBlock = document.createElement('div');
                        courseBlock.className = `absolute w-full p-2 text-left ${bgColor} bg-opacity-70 border-l-4 ${borderColor} rounded-r-lg overflow-hidden flex flex-col`;
                        courseBlock.style.top = `${startMinutes * (hourHeight / 60)}px`;
                        courseBlock.style.height = `${duration * (hourHeight / 60)}px`;
                        
                        const formattedStartTime = start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const formattedEndTime = end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                        courseBlock.innerHTML = `
                            <p class="font-bold text-xs">${course.name}</p>
                            <p class="text-xs text-gray-300">${formattedStartTime} - ${formattedEndTime}</p>
                            ${course.room ? `<p class="text-xs text-gray-300 mt-1">Room: ${course.room}</p>` : ''}
                            <button class="delete-course absolute top-1 right-1" data-group-id="${course.groupId}">
                                <i data-lucide="trash-2" class="w-3 h-3 text-red-400 hover:text-red-300"></i>
                            </button>
                        `;
                        
                        const dayColumn = document.getElementById(`schedule-col-${course.day}-${userId}`);
                        if (dayColumn) {
                            dayColumn.appendChild(courseBlock);
                        }
                    });
                    
                    document.querySelectorAll('.delete-course').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const groupId = e.currentTarget.dataset.groupId;
                            if (!confirm('Delete this event from all scheduled days?')) return;
                            
                            const qDelete = query(scheduleCollectionRef, where("groupId", "==", groupId));
                            const querySnapshot = await getDocs(qDelete);
                            const deleteBatch = writeBatch(db);
                            querySnapshot.forEach((doc) => {
                                deleteBatch.delete(doc.ref);
                            });
                            await deleteBatch.commit();
                        });
                    });
                    lucide.createIcons();
                });
            }

            document.getElementById(`semester-selector-${userId}`).addEventListener('click', (e) => {
                if (e.target.classList.contains('semester-btn')) {
                    const selectedSemester = e.target.dataset.semester;
                    if (selectedSemester === currentSemester) return;

                    currentSemester = selectedSemester;

                    document.querySelectorAll(`#semester-selector-${userId} .semester-btn`).forEach(btn => {
                        if (btn.dataset.semester === currentSemester) {
                            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                            btn.classList.add('bg-purple-600');
                        } else {
                            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                            btn.classList.remove('bg-purple-600');
                        }
                    });
                    setupScheduleListener();
                }
            });

            setupScheduleListener();
        }
        
        // 2. Task Tracker
        function initTaskTracker(userId) {
            const container = document.getElementById('task-tracker-widget');
            const tasksCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            let showArchived = false;

            const content = `
                <form id="add-task-form" class="flex gap-2 mb-4">
                    <input type="text" name="text" placeholder="New reading or outline..." class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <button type="submit" class="w-auto px-4 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </form>
                <div id="task-lists"></div>
            `;
            const widget = createWidget('Case Readings & Tasks', 'check-square', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById('add-task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(tasksCollectionRef, { text: form.text.value, done: false, createdAt: new Date() });
                form.reset();
            });

            onSnapshot(query(tasksCollectionRef, orderBy("createdAt", "desc")), (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activeTasks = tasks.filter(t => !t.done);
                const archivedTasks = tasks.filter(t => t.done);
                const taskLists = document.getElementById('task-lists');

                taskLists.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="font-bold mb-2">To-Do</h3>
                        <ul class="space-y-2">
                            ${activeTasks.length > 0 ? activeTasks.map(task => `
                                <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                                    <button class="toggle-task" data-id="${task.id}" data-done="${task.done}"><div class="w-5 h-5 rounded border-2 border-gray-500"></div></button>
                                    <span>${task.text}</span>
                                    <button class="delete-task ml-auto" data-id="${task.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                                </li>
                            `).join('') : '<p class="text-sm text-gray-500">No active tasks. Add one above!</p>'}
                        </ul>
                        <div>
                            <button id="toggle-archive" class="font-bold mb-2 flex items-center gap-2 text-sm text-gray-400 hover:text-gray-200">
                                <i data-lucide="archive" class="w-4 h-4"></i> Archived (${archivedTasks.length}) <i data-lucide="${showArchived ? 'chevron-up' : 'chevron-down'}" class="ml-1"></i>
                            </button>
                            <ul id="archive-list" class="space-y-2 mt-2 ${showArchived ? '' : 'hidden'}">
                                ${archivedTasks.map(task => `
                                    <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                                        <button class="toggle-task" data-id="${task.id}" data-done="${task.done}"><div class="w-5 h-5 rounded border-2 bg-purple-500 border-purple-500 flex items-center justify-center"><i data-lucide="check" class="w-4 h-4"></i></div></button>
                                        <span class="line-through text-gray-500">${task.text}</span>
                                        <button class="delete-task ml-auto" data-id="${task.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('toggle-archive').addEventListener('click', () => {
                    showArchived = !showArchived;
                    document.getElementById('archive-list').classList.toggle('hidden');
                    document.querySelector('#toggle-archive i:last-child').outerHTML = `<i data-lucide="${showArchived ? 'chevron-up' : 'chevron-down'}" class="ml-1"></i>`;
                    lucide.createIcons();
                });

                taskLists.querySelectorAll('.toggle-task').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const done = e.currentTarget.dataset.done === 'true';
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', id), { done: !done });
                }));
                taskLists.querySelectorAll('.delete-task').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', id));
                }));
                lucide.createIcons();
            });
        }

        // 3. Job Application Center
        function initJobAppCenter(userId) {
            const container = document.getElementById('job-app-widget');
            const appsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'job_applications');
            const statuses = ["Applied", "Interviewing", "Offer", "Rejected"];

            const getStatusColor = (status) => {
                const colors = {
                    'Offer': 'bg-green-500 text-green-900',
                    'Interviewing': 'bg-blue-500 text-blue-900',
                    'Applied': 'bg-yellow-500 text-yellow-900',
                    'Rejected': 'bg-red-500 text-red-900'
                };
                return colors[status] || 'bg-gray-500 text-gray-900';
            };

            const content = `
                <form id="add-app-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input type="text" name="company" placeholder="Firm / Organization" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <input type="text" name="position" placeholder="e.g. Summer Associate" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                    <button type="submit" class="sm:col-span-2 w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2">Add Application</button>
                </form>
                <div id="app-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            `;
            const widget = createWidget('Job Application Center', 'briefcase', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));

            document.getElementById('add-app-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(appsCollectionRef, {
                    company: form.company.value,
                    position: form.position.value,
                    status: 'Applied',
                    date: new Date().toISOString().split('T')[0]
                });
                form.reset();
            });

            onSnapshot(query(appsCollectionRef, orderBy("date", "desc")), (snapshot) => {
                const appList = document.getElementById('app-list');
                if (snapshot.empty) {
                    appList.innerHTML = '<p class="text-sm text-gray-500">No job applications tracked yet.</p>';
                    return;
                }
                appList.innerHTML = snapshot.docs.map(docSnap => {
                    const app = { id: docSnap.id, ...docSnap.data() };
                    return `
                        <div class="p-3 bg-gray-800 bg-opacity-40 rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <div>
                                <p class="font-bold flex items-center gap-2"><i data-lucide="building" class="w-4 h-4"></i> ${app.company}</p>
                                <p class="text-sm text-gray-300">${app.position}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <select class="update-status text-xs p-2 w-auto rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 font-bold ${getStatusColor(app.status)}" data-id="${app.id}">
                                    ${statuses.map(s => `<option value="${s}" ${s === app.status ? 'selected' : ''} class="bg-gray-800 text-white">${s}</option>`).join('')}
                                </select>
                                <p class="text-xs text-gray-400"><i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>${app.date}</p>
                                <button class="delete-app" data-id="${app.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                appList.querySelectorAll('.update-status').forEach(select => select.addEventListener('change', async (e) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'job_applications', e.target.dataset.id), { status: e.target.value });
                }));
                appList.querySelectorAll('.delete-app').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'job_applications', e.currentTarget.dataset.id));
                }));
                lucide.createIcons();
            });
        }

        // 4. Journal & Goals
        function initJournalAndGoals(userId) {
            const container = document.getElementById('journal-goals-widget');
            const goalsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'goals');
            const journalCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'journal_entries');

            const converter = new showdown.Converter({
                simplifiedAutoLink: true,
                strikethrough: true,
                tables: true,
                tasklists: true,
                simpleLineBreaks: true
            });

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Goals -->
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="target" class="text-blue-400"></i> Career & Academic Goals</h3>
                        <form id="add-goal-form" class="flex gap-2 mb-4">
                            <input type="text" name="text" placeholder="e.g. Make Law Review" class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" required />
                            <button type="submit" class="w-auto px-4 p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold flex items-center justify-center gap-2"><i data-lucide="plus"></i></button>
                        </form>
                        <ul id="goal-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>
                    <!-- Journal -->
                    <div>
                        <h3 class="text-lg font-bold mb-3">Journal & AI Assistant</h3>
                        <form id="add-entry-form">
                            <textarea id="journal-textarea" name="text" placeholder="Write your thoughts down using Markdown, or get some input from an AI assistant..." class="w-full p-3 bg-gray-800 bg-opacity-70 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 h-32 resize-none mb-2" required></textarea>
                            <div class="flex gap-2">
                                <button type="submit" class="w-full p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold">Save Entry</button>
                                <button type="button" id="ai-assistant-button" class="w-full p-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold flex items-center justify-center gap-2">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span>AI Assistant</span>
                                    <div id="ai-loader" class="loader hidden"></div>
                                </button>
                            </div>
                        </form>
                        <div id="entry-list" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            `;
            const widget = createWidget('Journal & Goals', 'edit-3', content, true);
            container.innerHTML = widget.html;
            document.getElementById(`toggle-${widget.id}`).addEventListener('click', () => widget.toggle(container));
            lucide.createIcons();

            // AI Assistant Logic
            const aiButton = document.getElementById('ai-assistant-button');
            const journalTextarea = document.getElementById('journal-textarea');
            const aiLoader = document.getElementById('ai-loader');
            const aiButtonText = aiButton.querySelector('span');

            aiButton.addEventListener('click', async () => {
                const prompt = journalTextarea.value;
                if (!prompt.trim()) {
                    alert("Please enter some text for the AI assistant.");
                    return;
                }

                aiLoader.classList.remove('hidden');
                aiButtonText.textContent = "Thinking...";
                aiButton.disabled = true;

                try {
                    const response = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        }),
                    });
                    
                    const responseText = await response.text();

                    if (!response.ok) {
                        throw new Error(`AI service error: ${response.status} ${response.statusText}. Details: ${responseText}`);
                    }
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(`Failed to parse AI response. Received: ${responseText}`);
                    }

                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        journalTextarea.value = aiText;
                    } else {
                        throw new Error("No valid response from AI assistant. The content may have been filtered or the response structure was unexpected.");
                    }

                } catch (error) {
                    console.error("AI Assistant Error:", error);
                    alert(`An error occurred: ${error.message}`);
                } finally {
                    aiLoader.classList.add('hidden');
                    aiButtonText.textContent = "AI Assistant";
                    aiButton.disabled = false;
                }
            });

            // Goals Logic
            document.getElementById('add-goal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                await addDoc(goalsCollectionRef, { text: form.text.value, done: false });
                form.reset();
            });
            onSnapshot(goalsCollectionRef, snapshot => {
                const goalList = document.getElementById('goal-list');
                if (snapshot.empty) {
                    goalList.innerHTML = '<p class="text-sm text-gray-500">No goals set yet.</p>';
                    return;
                }
                goalList.innerHTML = snapshot.docs.map(docSnap => {
                    const goal = { id: docSnap.id, ...docSnap.data() };
                    return `
                        <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-800 transition-colors">
                            <button class="toggle-goal" data-id="${goal.id}" data-done="${goal.done}"><div class="w-5 h-5 rounded-full border-2 ${goal.done ? 'bg-purple-500 border-purple-500' : 'border-gray-500'} flex items-center justify-center">${goal.done ? '<i data-lucide="star" class="w-3 h-3"></i>' : ''}</div></button>
                            <span class="${goal.done ? 'line-through text-gray-500' : ''}">${goal.text}</span>
                            <button class="delete-goal ml-auto" data-id="${goal.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                        </li>
                    `;
                }).join('');
                goalList.querySelectorAll('.toggle-goal').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const done = e.currentTarget.dataset.done === 'true';
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'goals', id), { done: !done });
                }));
                goalList.querySelectorAll('.delete-goal').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'goals', id));
                }));
                lucide.createIcons();
            });

            // Journal Logic
            document.getElementById('add-entry-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                if (document.activeElement.id === 'ai-assistant-button') return;

                await addDoc(journalCollectionRef, {
                    text: form.text.value,
                    date: new Date().toISOString().split('T')[0]
                });
                form.reset();
            });
            onSnapshot(query(journalCollectionRef, orderBy("date", "desc")), snapshot => {
                const entryList = document.getElementById('entry-list');
                if (snapshot.empty) {
                    entryList.innerHTML = '<p class="text-sm text-gray-500">No journal entries yet.</p>';
                    return;
                }
                entryList.innerHTML = snapshot.docs.map(docSnap => {
                    const entry = { id: docSnap.id, ...docSnap.data() };
                    const htmlContent = converter.makeHtml(entry.text);
                    return `
                        <div class="p-3 bg-gray-800 bg-opacity-40 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-semibold text-purple-300">${new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                                <button class="delete-entry" data-id="${entry.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 hover:text-red-400"></i></button>
                            </div>
                            <div class="prose text-gray-300 max-w-none">${htmlContent}</div>
                        </div>
                    `;
                }).join('');
                entryList.querySelectorAll('.delete-entry').forEach(btn => btn.addEventListener('click', async (e) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'journal_entries', e.currentTarget.dataset.id));
                }));
                lucide.createIcons();
            });
            lucide.createIcons();
        }

    </script>
</body>
</html>
